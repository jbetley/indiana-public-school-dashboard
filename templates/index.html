<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
   <title>Indiana School Academic Dashboard</title>
   
   <!-- Imported Fonts -->
   <link  rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
   <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-zrnmn8R8KkWl12rAZFt4yKjxplaDaT7/EUkKm7AovijfrQItFWR7O/JJn4DAa/gx" crossorigin="anonymous">
   
   <!-- Third-Party Modules -->
   <script src="{{ url_for('static', filename='slimselect.min.js')}}"></script>
   <script src="{{ url_for('static', filename='d3.v5.js')}}"></script>
   <script src="{{ url_for('static', filename='ag-grid-community.min.js')}}"></script>
   
   <!-- Local Modules -->
   <script src="{{ url_for('static', filename='d3-helpers.js')}}"></script>
   <script src="{{ url_for('static', filename='helpers.js')}}"></script>
   <script src="{{ url_for('static', filename='utils.js')}}"></script>
   <script src="{{ url_for('static', filename='d3-utils.js')}}"></script>   

   <!-- Imported Stylesheets -->
   <link rel="stylesheet" media="all" href="{{ url_for('static', filename='dashboard.css')}}">
   <link rel="stylesheet" media="all" href="{{ url_for('static', filename='slim-select.css')}}">
</head>
<body>
   <h3>Indiana Public School Academic Dashboard</h3>
   <form name="dashboardselect" id="dropdown">
      <label>Select School Corporation:</label>
      <select name="corporation" id="corpSelect"></select>
      <br>
      <label>Select School:</label>
      <select name="school" id="schoolSelect"></select>
      <br>
      <label>Select Year:</label>
      <select name="year" id="yearSelect"></select>
   </form>

   <div id ="allnav">
      <div class="row">
         <div class="nav-container twelve columns">
            <div id="nav-tabs" class="nav">
               <button data-tab="tab-n-1" id="demoTab" class="tab main active">Demographics</button>
               <button data-tab="tab-n-2" id="infoTab" class="tab main">Academic Information</button>
               <button data-tab="tab-n-3" id="analysisTab" class="tab main">Academic Analysis</button>
            </div>
         </div>
      </div>
      <div class="row">
         <div class="nav-container twelve columns">
            <div id="analysisnav-tabs" class="analysisnav">
               <button data-analysistab="tab-a-1" id="singleTab" class="tab analysis active">Selected Year</button>
               <button data-analysistab="tab-a-2" id="multiTab" class="tab analysis">Multi-Year</button>
            </div>
         </div>
      </div>               
      <div class="row">
         <div class="nav-container twelve columns">
            <div id="typenav-tabs" class="typenav">
               <button data-typetab="tab-t-1" id="k8Tab" class="tab type active">K8</button>
               <button data-typetab="tab-t-2" id="hsTab" class="tab type">HS</button>
            </div>
         </div>
      </div>
      <div class="row">
         <div class="nav-container twelve columns">
            <div id="k8nav-tabs" class="k8nav">
               <button data-k8tab="tab-k-1" id="ilearnTab" class="tab k8info active">ILEARN</button>
               <button data-k8tab="tab-k-2" id="ireadTab" class="tab k8info">IREAD</button>
            </div>
         </div>
      </div>
      <div class="row">
         <div class="nav-container twelve columns">
            <div id="hsnav-tabs" class="hsnav">
               <button data-hstab="tab-h-1" id="gradTab" class="tab hsinfo active">Graduation Rate</button>
               <button data-hstab="tab-h-2" id="satTab" class="tab hsinfo">SAT</button>
            </div>
         </div>
      </div>      
   </div>
   <div class="row">
      <div class="panel-container">
         <div id="tab-content">
            <div data-tab="tab-n-1" class="active">
               <section id="tab-one">
                  <div class="grid">
                     <div class="empty-box tab1-a-label" id="demo-container-1-label-1"><div class="label__header"><div id="demo-container-1-label-1-text">Total Enrollment</div></div></div>
                     <div class="table-box tab1-a1-table" id="demo-container-1-table-1"><div id="enrollmentTable" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab1-a2-lines" id="demo-container-1-chart-1"><div id="enrollmentChart"></div></div>

                     <div class="empty-box tab1-b-label" id="demo-container-2-label-2"><div class="label__header" id="demo-container-2-label-1-text">Attendance Rate and Chronic Absenteeism</div></div>
                     <div class="table-box tab1-b1-table" id="demo-container-2-table-2"><div id="attendanceTable" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab1-b2-lines" id="demo-container-2-chart-2"><div id="attendanceChart"></div></div>

                     <div class="group-box tab1-c1-stack" id="demo-container-3-stack-1"><div id="ethnicityDemoChart"></div></div>
                     <div class="group-box tab1-c2-stack" id="demo-container-3-stack-2"><div id="statusDemoChart"></div></div>
                  </div>
               </section>
            </div>
            <div data-tab="tab-n-2">
               <section id="tab-two">
                  <div class="grid">
                     <div class="empty-box tab2-label-1" id="info-container-iread-label-1"><div id="info-iread-label-1" class="label__header"></div></div>
                     <div class="table-box tab2-table-1" id="info-container-iread-table-1"><div id="info-iread-table-1" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-1" id="info-container-iread-chart-1"><div id="ireadInfoTotal"></div></div>

                     <div class="empty-box tab2-label-2" id="info-container-iread-label-2"><div id="info-iread-label-2" class="label__header"></div></div>
                     <div class="table-box tab2-table-2" id="info-container-iread-table-2"><div id="info-iread-table-2" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-2" id="info-container-iread-chart-2"><div id="ireadInfoEthnicity"></div></div>

                     <div class="empty-box tab2-label-3" id="info-container-iread-label-3"><div id="info-iread-label-3" class="label__header"></div></div>
                     <div class="table-box tab2-table-3" id="info-container-iread-table-3"><div id="info-iread-table-3" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-3" id="info-container-iread-chart-3"><div id="ireadInfoSubgroup"></div></div>

                     <div class="empty-box tab2-label-4" id="info-container-ilearn-label-4"><div id="info-ilearn-label-4" class="label__header"></div></div>
                     <div class="table-box tab2-table-4" id="info-container-ilearn-table-4"><div id="info-ilearn-table-4" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-4" id="info-container-ilearn-chart-4"><div id="elaIlearnInfoGrade"></div></div>
                     <div class="stack-box tab2-stack-4" id="info-container-ilearn-stack-4"><div id="elaIlearnInfoStackGrade"></div></div>

                     <div class="empty-box tab2-label-5" id="info-container-ilearn-label-5"><div id="info-ilearn-label-5" class="label__header"></div></div>
                     <div class="table-box tab2-table-5" id="info-container-ilearn-table-5"><div id="info-ilearn-table-5" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-5" id="info-container-ilearn-chart-5"><div id="elaIlearnInfoEthnicity"></div></div>
                     <div class="stack-box tab2-stack-5" id="info-container-ilearn-stack-5"><div id="elaIlearnInfoStackEthnicity"></div></div>

                     <div class="empty-box tab2-label-6" id="info-container-ilearn-label-6"><div id="info-ilearn-label-6" class="label__header"></div></div>
                     <div class="table-box tab2-table-6" id="info-container-ilearn-table-6"><div id="info-ilearn-table-6" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-6" id="info-container-ilearn-chart-6"><div id="elaIlearnInfoSubgroup"></div></div>
                     <div class="stack-box tab2-stack-6" id="info-container-ilearn-stack-6"><div id="elaIlearnInfoStackSubgroup"></div></div>

                     <div class="empty-box tab2-label-7" id="info-container-ilearn-label-7"><div id="info-ilearn-label-7" class="label__header"></div></div>
                     <div class="table-box tab2-table-7" id="info-container-ilearn-table-7"><div id="info-ilearn-table-7" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-7" id="info-container-ilearn-chart-7"><div id="mathIlearnInfoGrade"></div></div>
                     <div class="stack-box tab2-stack-7" id="info-container-ilearn-stack-7"><div id="mathIlearnInfoStackGrade"></div></div>

                     <div class="empty-box tab2-label-8" id="info-container-ilearn-label-8"><div id="info-ilearn-label-8" class="label__header"></div></div>
                     <div class="table-box tab2-table-8" id="info-container-ilearn-table-8"><div id="info-ilearn-table-8" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-8" id="info-container-ilearn-chart-8"><div id="mathIlearnInfoEthnicity"></div></div>
                     <div class="stack-box tab2-stack-8" id="info-container-ilearn-stack-8"><div id="mathIlearnInfoStackEthnicity"></div></div>

                     <div class="empty-box tab2-label-9" id="info-container-ilearn-label-9"><div id="info-ilearn-label-9" class="label__header"></div></div>
                     <div class="table-box tab2-table-9" id="info-container-ilearn-table-9"><div id="info-ilearn-table-9" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-9" id="info-container-ilearn-chart-9"><div id="mathIlearnInfoSubgroup"></div></div>
                     <div class="stack-box tab2-stack-9" id="info-container-ilearn-stack-9"><div id="mathIlearnInfoStackSubgroup"></div></div>

                     <div class="empty-box tab2-label-10" id="info-container-gradrate-label-10"><div id="info-gradrate-label-10" class="label__header"></div></div>
                     <div class="table-box tab2-table-10" id="info-container-gradrate-table-10"><div id="info-gradrate-table-10" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-10" id="info-container-gradrate-chart-10"><div id="gradRateInfoTotal"></div></div>

                     <div class="empty-box tab2-label-11" id="info-container-gradrate-label-11"><div id="info-gradrate-label-11" class="label__header"></div></div>
                     <div class="table-box tab2-table-11" id="info-container-gradrate-table-11"><div id="info-gradrate-table-11" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-11" id="info-container-gradrate-chart-11"><div id="gradRateInfoEthnicity"></div></div>

                     <div class="empty-box tab2-label-12" id="info-container-gradrate-label-12"><div id="info-gradrate-label-12" class="label__header"></div></div>
                     <div class="table-box tab2-table-12" id="info-container-gradrate-table-12"><div id="info-gradrate-table-12" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-12" id="info-container-gradrate-chart-12"><div id="gradRateInfoSubgroup"></div></div>

                     <div class="empty-box tab2-label-13" id="info-container-sat-label-13"><div id="info-sat-label-13" class="label__header"></div></div>
                     <div class="table-box tab2-table-13" id="info-container-sat-table-13"><div id="info-sat-table-13" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-13" id="info-container-sat-chart-13"><div id="ebrwSatInfoTotal"></div></div>

                     <div class="empty-box tab2-label-14" id="info-container-sat-label-14"><div id="info-sat-label-14" class="label__header"></div></div>
                     <div class="table-box tab2-table-14" id="info-container-sat-table-14"><div id="info-sat-table-14" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-14" id="info-container-sat-chart-14"><div id="ebrwSatInfoEthnicity"></div></div>

                     <div class="empty-box tab2-label-15" id="info-container-sat-label-15"><div id="info-sat-label-15" class="label__header"></div></div>
                     <div class="table-box tab2-table-15" id="info-container-sat-table-15"><div id="info-sat-table-15" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-15" id="info-container-sat-chart-15"><div id="ebrwSatInfoSubgroup"></div></div>

                     <div class="empty-box tab2-label-16" id="info-container-sat-label-16"><div id="info-sat-label-16" class="label__header"></div></div>
                     <div class="table-box tab2-table-16" id="info-container-sat-table-16"><div id="info-sat-table-16" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-16" id="info-container-sat-chart-16"><div id="mathSatInfoTotal"></div></div>

                     <div class="empty-box tab2-label-17" id="info-container-sat-label-17"><div id="info-sat-label-17" class="label__header"></div></div>
                     <div class="table-box tab2-table-17" id="info-container-sat-table-17"><div id="info-sat-table-17" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-17" id="info-container-sat-chart-17"><div id="mathSatInfoEthnicity"></div></div>

                     <div class="empty-box tab2-label-18" id="info-container-sat-label-18"><div id="info-sat-label-18" class="label__header"></div></div>
                     <div class="table-box tab2-table-18" id="info-container-sat-table-18"><div id="info-sat-table-18" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-18" id="info-container-sat-chart-18"><div id="mathSatInfoSubgroup"></div></div>                     
                  </div>
               </section>
            </div>
            <div data-tab="tab-n-3">
               <section id="tab-three">
               <div class="row">
                  <div class="nav-container twelve columns">
                     <label id="comparisonLabel">Add or Remove Schools:</label>
                     <select id="comparisonSelect" multiple></select>
                     <div id="max-message"></div>
                  </div>
               </div>
               <div class="row">
                  <div class="nav-container twelve columns">
                     <div class="grid">
                        <div class="empty-box tab3-label-1" id="analysis-container-iread-label-1"><div id="analysis-iread-label-1" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-1" id="analysis-container-iread-chart-1"><div id="ireadComparisonTotal"></div></div>
                        <div class="table-box tab3-table-1" id="analysis-container-iread-table-1">
                           <div id="analysis-iread-table-1" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-iread-msg-1"></div>
                        </div>

                        <div class="empty-box tab3-label-2" id="analysis-container-iread-label-2"><div id="analysis-iread-label-2" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-2" id="analysis-container-iread-chart-2"><div id="ireadComparisonEthnicity"></div></div>
                        <div class="table-box tab3-table-2" id="analysis-container-iread-table-2">
                           <div id="analysis-iread-table-2" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-iread-msg-2"></div>
                        </div>
                        

                        <div class="empty-box tab3-label-3" id="analysis-container-iread-label-3"><div id="analysis-iread-label-3" class="label__header"></div></div>                        
                        <div class="stack-box tab3-chart-3" id="analysis-container-iread-chart-3"><div id="ireadComparisonSubgroup"></div></div>
                        <div class="table-box tab3-table-3" id="analysis-container-iread-table-3">
                           <div id="analysis-iread-table-3" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-iread-msg-3"></div>
                        </div>

                        <div class="empty-box tab3-label-4" id="analysis-container-ilearn-label-4"><div id="analysis-ilearn-label-4" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-4" id="analysis-container-ilearn-chart-4"><div id="elaILEARNComparisonTotal"></div></div>
                        <div class="table-box tab3-table-4" id="analysis-container-ilearn-table-4">
                           <div id="analysis-ilearn-table-4" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-ilearn-msg-4"></div>
                        </div>
                        
                        <div class="empty-box tab3-label-5" id="analysis-container-ilearn-label-5"><div id="analysis-ilearn-label-5" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-5" id="analysis-container-ilearn-chart-5"><div id="elaILEARNComparisonGrade"></div></div>
                        <div class="table-box tab3-table-5" id="analysis-container-ilearn-table-5">
                           <div id="analysis-ilearn-table-5" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-ilearn-msg-5"></div>
                        </div>

                        <div class="empty-box tab3-label-6" id="analysis-container-ilearn-label-6"><div id="analysis-ilearn-label-6" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-6" id="analysis-container-ilearn-chart-6"><div id="elaILEARNComparisonEthnicity"></div></div>
                        <div class="table-box tab3-table-6" id="analysis-container-ilearn-table-6">
                           <div id="analysis-ilearn-table-6" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-ilearn-msg-6"></div>
                        </div>
                        
                        <div class="empty-box tab3-label-7" id="analysis-container-ilearn-label-7"><div id="analysis-ilearn-label-7" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-7" id="analysis-container-ilearn-chart-7"><div id="elaILEARNComparisonSubgroup"></div></div>
                        <div class="table-box tab3-table-7" id="analysis-container-ilearn-table-7">
                           <div id="analysis-ilearn-table-7" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-ilearn-msg-7"></div>
                        </div>
                     
                        <div class="empty-box tab3-label-8" id="analysis-container-ilearn-label-8"><div id="analysis-ilearn-label-8" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-8" id="analysis-container-ilearn-chart-8"><div id="mathILEARNComparisonTotal"></div></div>
                        <div class="table-box tab3-table-8" id="analysis-container-ilearn-table-8">
                           <div id="analysis-ilearn-table-8" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-ilearn-msg-8"></div>
                        </div>

                        <div class="empty-box tab3-label-9" id="analysis-container-ilearn-label-9"><div id="analysis-ilearn-label-9" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-9" id="analysis-container-ilearn-chart-9"><div id="mathILEARNComparisonGrade"></div></div>
                        <div class="table-box tab3-table-9" id="analysis-container-ilearn-table-9">
                           <div id="analysis-ilearn-table-9" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-ilearn-msg-9"></div>
                        </div>

                        <div class="empty-box tab3-label-10" id="analysis-container-ilearn-label-10"><div id="analysis-ilearn-label-10" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-10" id="analysis-container-ilearn-chart-10"><div id="mathILEARNComparisonEthnicity"></div></div>
                        <div class="table-box tab3-table-10" id="analysis-container-ilearn-table-10">
                           <div id="analysis-ilearn-table-10" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-ilearn-msg-10"></div>
                        </div>

                        <div class="empty-box tab3-label-11" id="analysis-container-ilearn-label-11"><div id="analysis-ilearn-label-11" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-11" id="analysis-container-ilearn-chart-11"><div id="mathILEARNComparisonSubgroup"></div></div>
                        <div class="table-box tab3-table-11" id="analysis-container-ilearn-table-11">
                           <div id="analysis-ilearn-table-11" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-ilearn-msg-11"></div>
                        </div>

                        <div class="empty-box tab3-label-12" id="analysis-container-gradrate-label-12"><div id="analysis-grad-label-12" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-12" id="analysis-container-gradrate-chart-12"><div id="gradRateComparisonTotal"></div></div>
                        <div class="table-box tab3-table-12" id="analysis-container-gradrate-table-12">
                           <div id="analysis-gradrate-table-12" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-gradrate-msg-12"></div>
                        </div>

                        <div class="empty-box tab3-label-13" id="analysis-container-gradrate-label-13"><div id="analysis-grad-label-13" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-13" id="analysis-container-gradrate-chart-13"><div id="gradRateComparisonEthnicity"></div></div>
                        <div class="table-box tab3-table-13" id="analysis-container-gradrate-table-13">
                           <div id="analysis-gradrate-table-13" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-gradrate-msg-13"></div>
                        </div>
                        
                        <div class="empty-box tab3-label-14" id="analysis-container-gradrate-label-14"><div id="analysis-grad-label-14" class="label__header"></div></div>                        
                        <div class="stack-box tab3-chart-14" id="analysis-container-gradrate-chart-14"><div id="gradRateComparisonSubgroup"></div></div>
                        <div class="table-box tab3-table-14" id="analysis-container-gradrate-table-14">
                           <div id="analysis-gradrate-table-14" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-gradrate-msg-14"></div>
                        </div>

                        <div class="empty-box tab3-label-15" id="analysis-container-sat-label-15"><div id="analysis-sat-label-15" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-15" id="analysis-container-sat-chart-15"><div id="satComparisonTotal"></div></div>
                        <div class="table-box tab3-table-15" id="analysis-container-sat-table-15">
                           <div id="analysis-sat-table-15" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-sat-msg-15"></div>
                        </div>
                        
                        <div class="empty-box tab3-label-16" id="analysis-container-sat-label-16"><div id="analysis-sat-label-16" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-16" id="analysis-container-sat-chart-16"><div id="satComparisonEthnicity"></div></div>
                        <div class="table-box tab3-table-16" id="analysis-container-sat-table-16">
                           <div id="analysis-sat-table-16" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-sat-msg-16"></div>
                        </div>

                        <div class="empty-box tab3-label-17" id="analysis-container-sat-label-17"><div id="analysis-sat-label-17" class="label__header"></div></div>
                        <div class="stack-box tab3-chart-17" id="analysis-container-sat-chart-17"><div id="satComparisonSubgroup"></div></div>
                        <div class="table-box tab3-table-17" id="analysis-container-sat-table-17">
                           <div id="analysis-sat-table-17" style="width: 100%" class="ag-theme-quartz"></div>
                           <div id="analysis-sat-msg-17"></div>
                        </div>
                     </div>
                  </div>
               </div>
               </section>
            </div>
         </div>
      </div>
   </div>
</body>
<script type="module">


// Indiana Public School Academic Dashboard
// author:   jbetley (https://github.com/jbetley)
// version:  0.9
// date:     02.09.25

// Max Academic and Demographic Years
const getMaxYears = `${window.origin}/config`;
const yearResponse = await fetch(getMaxYears);
const maxYears = await yearResponse.json();

const curAcademicYear = maxYears.academic_year
const curDemographicYear = maxYears.demographic_year

// List of Corporation and School Names for dropdown
const allSchoolsUrl = `${window.origin}/load`;
const allSchoolsResponse = await fetch(allSchoolsUrl);
var allSchoolsObj = await allSchoolsResponse.json();

allSchoolsObj.forEach(function (obj) {
   obj["Corporation Name"] = obj["Corporation Name"] + " (" + toString(obj["Corporation ID"]) + ")"
   obj["School Name"] = obj["School Name"] + " (" + toString(obj["School ID"]) + ")"
});

// chart variables
const subjectIlearn = ["ELA", "ELA", "ELA", "ELA", "Math", "Math", "Math", "Math"];
const subjectGrad = ["Graduation", "Graduation", "Graduation"];
const subjectIread = ["IREAD", "IREAD", "IREAD"];
const subjectSAT = ["EBRW", "EBRW", "EBRW", "Math", "Math", "Math"];
const gradeAll = ["Grade 3", "Grade 4", "Grade 5", "Grade 6", "Grade 7", "Grade 8", "Total"];
const grade = ["Grade 3", "Grade 4", "Grade 5", "Grade 6", "Grade 7", "Grade 8"];
const total = ["Total"];
const gradTotal = ["Total", "Non Waiver"];
const ethnicity = ["American Indian","Asian","Black","Hispanic","Multiracial","Native Hawaiian or Other Pacific Islander","White"];
const subgroup = ["Special Education","General Education","Paid Meals","Free or Reduced Price Meals","English Language Learners",
   "Non English Language Learners"];
const categoryList = [grade, ethnicity, subgroup];
const allCategories = ethnicity + subgroup + grade;
const ilearnLabelSuffixes = ["by Grade", "by Ethnicity", "by Subgroup", "by Grade", "by Ethnicity", "by Subgroup"];
const IREADLabelSuffixes = ["Total", "by Ethnicity", "by Subgroup"];
const analysisLabelSuffixes = ["Total", "Total", "Total", "by Ethnicity", "by Subgroup", "by Grade", "by Ethnicity", "by Subgroup"];
const gradLabelSuffixes = ["Overview", "by Ethnicity", "by Subgroup"];
const satLabelSuffixes = ["Overview", "by Ethnicity", "by Subgroup", "Overview", "by Ethnicity", "by Subgroup"];

const colorList = [ "#7b6888", "#df8f2d", "#a8b462", "#ebbb81", "#74a2d7", "#d4773f",
   "#83941f", "#f0c33b", "#bc986a", "#96b8db"];
let colorState = [];

// Demographic Page
var enrollmentChart,
   attendanceChart,
   ethnicityDemoChart,
   statusDemoChart,
   enrollmentTableGridApi,
   attendanceTableGridApi;

// Academic Info Page
var ireadInfoTotal,
   ireadInfoEthnicity,
   ireadInfoSubgroup,
   elaIlearnInfoGrade,
   elaIlearnInfoStackGrade,
   elaIlearnInfoEthnicity,
   elaIlearnInfoStackEthnicity,
   elaIlearnInfoSubgroup,
   elaIlearnInfoStackSubgroup,
   mathIlearnInfoGrade,
   mathIlearnInfoStackGrade,
   mathIlearnInfoEthnicity,
   mathIlearnInfoStackEthnicity,
   mathIlearnInfoSubgroup,
   mathIlearnInfoStackSubgroup,
   gradRateInfoTotal,
   gradRateInfoEthnicity,
   gradRateInfoSubgroup,
   ebrwSatInfoTotal,
   ebrwSatInfoEthnicity,
   ebrwSatInfoSubgroup,
   mathSatInfoTotal,
   mathSatInfoEthnicity,
   mathSatInfoSubgroup;

var infoGridApi = [];

// Analysis Page
var elaILEARNComparisonTotal,
   elaILEARNComparisonGrade,
   elaILEARNComparisonEthnicity,
   elaILEARNComparisonSubgroup,
   ireadComparisonTotal,
   ireadComparisonEthnicity,
   ireadComparisonSubgroup,
   mathILEARNComparisonTotal,
   mathILEARNComparisonGrade,
   mathILEARNComparisonEthnicity,
   mathILEARNComparisonSubgroup,
   gradRateComparisonTotal,
   gradRateComparisonEthnicity,
   gradRateComparisonSubgroup,
   satComparisonTotal,
   satComparisonEthnicity,
   satComparisonSubgroup;   

var analysisGridApi = [];   

// https://www.pluralsight.com/resources/blog/guides/handling-nested-http-requests-using-the-fetch-api
// https://dev.to/alexmercedcoder/making-multiple-api-calls-in-javascript-kip
// https://www.makeuseof.com/tag/python-javascript-communicate-json/
// https://stackoverflow.com/questions/66978996/is-there-a-better-way-of-creating-tabs-using-vanilla-javascript-than-this

// TODO: switch to search bar? Need to tweak Corp/School Dropdowns
// https://stackoverflow.com/questions/73066547/search-bar-with-dropdown-list
// https://stackoverflow.com/questions/68075281/search-for-item-in-long-dropdown-list-with-input-filter-but-only-allow-user-to
// https://stackoverflow.com/questions/64861548/searchable-drop-down

// https://slimselectjs.com/
// https://github.com/brianvoe/slim-select

/* Navigation */
const comparisonSelect = new SlimSelect({
  select: "#comparisonSelect",
  settings: {
    alwaysOpen: false,
    contentPosition: "absolute",
    placeholderText: "",
    minSelected: 1,
    maxSelected: 8,
    showSearch: true,
    closeOnSelect: true,
    hideSelected: true
  }
});


/* Event Listeners */

// New school corporation is selected (automatically changing school) or
// new school is selected
const schoolSelection = document.getElementById("schoolSelect");

schoolSelection.addEventListener("change", function () {
   let selectedValues = getSelectedValues();

   const mainSelection = document.querySelector(".tab.main.active").id;
   const k8Categories = document.querySelector(".k8nav");
   const hsCategories = document.querySelector(".hsnav");
   const typeCategories = document.querySelector(".typenav");
   const analysisPages = document.querySelector(".typenav");

   let k8TypeTab = document.getElementById("k8Tab");
   let hsTypeTab = document.getElementById("hsTab");

   if (selectedValues.school_type == "K12" && mainSelection != "demoTab") {
      typeCategories.classList.add("open");
   } else {
      typeCategories.classList.remove("open");
   }

   if (mainSelection == "demoTab") {
      k8Categories.classList.remove("open");
      hsCategories.classList.remove("open");
      analysisPages.classList.remove("open");
      getDemographicData(selectedValues)
   }

   else if (mainSelection == "infoTab") {

      analysisPages.classList.remove("open");

      if (selectedValues.school_type == "K8" ||
         (selectedValues.school_type == "K12" &&
         selectedValues.school_subtype == "K8") 
      ) {

         hsCategories.classList.remove("open");
         hsTypeTab.classList.remove("active");

         // no "IREAD" option for middle schools
         if (selectedValues.school_subtype == "MS") {
            k8Categories.classList.remove("open");
         } else {
            k8Categories.classList.add("open");
         }
         k8TypeTab.classList.add("active");
         selectedValues.type_tab = "k8Tab"
      }
      else if (selectedValues.school_type == "HS" ||
         (selectedValues.school_type == "K12" && 
         selectedValues.school_subtype == "HS")
      ) {
         k8Categories.classList.remove("open");
         hsCategories.classList.add("open");
         k8TypeTab.classList.remove("active");
         hsTypeTab.classList.add("active");
         selectedValues.type_tab = "hsTab"      
      }

      getAcademicInfoData(selectedValues);

   }
   else if (mainSelection == "analysisTab") {

      analysisPages.classList.add("open");

      if (selectedValues.school_type == "K8" ||
         (selectedValues.school_type == "K12" &&
         selectedValues.school_subtype == "K8") 
      ) {

         hsCategories.classList.remove("open");
         hsTypeTab.classList.remove("active");

         // no "IREAD" option for middle schools
         if (selectedValues.school_subtype == "MS") {
            k8Categories.classList.remove("open");
         } else {
            k8Categories.classList.add("open");
         }
         k8TypeTab.classList.add("active");
         selectedValues.type_tab = "k8Tab"
      }
      else if (selectedValues.school_type == "HS" ||
         (selectedValues.school_type == "K12" && 
         selectedValues.school_subtype == "HS")
      ) {
         k8Categories.classList.remove("open");
         hsCategories.classList.add("open");
         k8TypeTab.classList.remove("active");
         hsTypeTab.classList.add("active");
         selectedValues.type_tab = "hsTab"      
      }
      
      // populates selectedValues dict with new list of comparison school ids
      getComparisonSchools(selectedValues);
      selectedValues.comparison_schools = getComparisonSchoolIDs();
      getAcademicAnalysisData(selectedValues);

   };
});

function getSchoolSelection() {
   let schoolIDValue;
   if (schoolSelection != null && schoolSelection.value == "") {
      schoolIDValue = allSchoolsObj.find(e => typeof e !== "undefined")["School ID"]
   }
   else {
      schoolIDValue = schoolSelection.value
   }
   return schoolIDValue
};


// Select year
// NOTE: currently refreshes all data- may want to reuse existing dataset instead
let yearSelection = document.getElementById("yearSelect");

yearSelection.addEventListener("change", function () {
   let selectedValues = getSelectedValues();

   if (selectedValues.page_tab === "analysisTab") {

      selectedValues.comparison_schools = getComparisonSchoolIDs();
      getAcademicAnalysisData(selectedValues);
   }
   else if (selectedValues.page_tab === "infoTab")  {
      getAcademicInfoData(selectedValues);
   }
   else {
      getDemographicData(selectedValues)
   }
});


function getSelectedYear() {
   let yearSelectionValue = yearSelection.value;
   return yearSelectionValue;
};


// Select comparison schools
const comparisonSelection = document.getElementById("comparisonSelect");
const msgDiv = document.getElementById("max-message");

comparisonSelection.addEventListener("change", function () {

   // show message when maximum # of schools have been selected
   const numX = comparisonSelect.getSelected()
   if (numX.length === comparisonSelect.settings.maxSelected) {

      const msgElement = document.createElement('div');
      msgElement.classList.add('ss-max-selection-message');
      msgElement.textContent = 'Maximum number of schools (8) reached.';
      msgDiv.appendChild(msgElement);

      // Automatically hide the message after 5 seconds
      setTimeout(() => {
         msgElement.remove();
      }, 4000);
      } else {
         // remove if selections are reduced
         const msgElement = msgDiv.querySelector('.ss-max-selection-message');
         if (msgElement) {
            msgElement.remove();
         }
   }

   let selectedValues = getSelectedValues();

   if (selectedValues.page_tab === "analysisTab") {
      selectedValues.comparison_schools = getComparisonSchoolIDs();
      getAcademicAnalysisData(selectedValues);
   }
   });


function getComparisonSchoolIDs() {
   let selectedValues = getSelectedValues();
   let comparisonSchools = comparisonSelect.getSelected();
   return comparisonSchools
}


// Select new school corporation (auto triggers new school list)
const corpSelection = document.getElementById("corpSelect");
corpSelection.addEventListener("change", function () {
   setSchoolList(allSchoolsObj)
});


function getCorpSelection() {
   let corpIDValue;
   if (corpSelection != null && corpSelection.value == "") {
      // finds first element in array even if it falsy (but not if undefined)
      corpIDValue = allSchoolsObj.find(e => typeof e !== "undefined")["Corporation ID"]
   }
   else {
      corpIDValue = corpSelection.value
   }
   return corpIDValue
}


// get all active values
function getSelectedValues() {

   const year = getSelectedYear();
   const schoolId = getSchoolSelection();
   const corpId = getCorpSelection();
   const pageTab = document.querySelector(".tab.main.active").id;
   const typeTab = document.querySelector(".tab.type.active").id;
   const k8Tab = document.querySelector(".tab.k8info.active").id;
   const hsTab = document.querySelector(".tab.hsinfo.active").id;
   const analysisTab = document.querySelector(".tab.analysis.active").id;

   let schoolInfo = allSchoolsObj.filter(o => o["School ID"] == schoolId && o.Year == year);

   let school_type = schoolInfo[0]["School Type"]
   let school_subtype = schoolInfo[0]["Sub Type"]

   if (pageTab != "demoTab" && school_type == "K12") {
      if (typeTab == "hsTab") {
         school_subtype = "HS"
      }
      else {
         school_subtype = "K8"
      }
   }

   // using snake case here because we will be passing this dict
   // to python scripts
   let selectedValues = {};
   selectedValues.school_id = schoolId;
   selectedValues.year = year;
   selectedValues.school_type = school_type;
   selectedValues.school_subtype = school_subtype;
   selectedValues.comparison_schools = [];
   selectedValues.page_tab = pageTab;
   selectedValues.k8_tab = k8Tab;
   selectedValues.hs_tab = hsTab;
   selectedValues.type_tab = typeTab;
   selectedValues.analysis_tab = analysisTab; 

   return selectedValues
}


function setSelectedValue(key, value) {
   selectedValues[key] = value;
}


// Navigation
// https://stackoverflow.com/questions/66978996/is-there-a-better-way-of-creating-tabs-using-vanilla-javascript-than-this
// https://stackoverflow.com/questions/50774938/vanilla-javascript-toggle-drop-down-menu

// switches active status and hides or shows subnavigation
const navTabs = document.querySelector("div#nav-tabs"),
   nav_tab_elms = document.querySelectorAll("button[data-tab], div[data-tab]"),
   k8navTabs = document.querySelector("div#k8nav-tabs"),
   k8nav_tab_elms = document.querySelectorAll("button[data-k8tab]"),
   hsnavTabs = document.querySelector("div#hsnav-tabs"),
   hsnav_tab_elms = document.querySelectorAll("button[data-hstab]"),
   typenavTabs = document.querySelector("div#typenav-tabs"),
   typenav_tab_elms = document.querySelectorAll("button[data-typetab]"),
   analysisnavTabs = document.querySelector("div#analysisnav-tabs"),
   analysisnav_tab_elms = document.querySelectorAll("button[data-analysistab]");


navTabs.onclick = ({target}) => {

   const schoolType = getSelectedValues().school_type;
   const schoolSubtype = getSelectedValues().school_subtype;

   // ignore other clicks in this area (like spaces between buttons)
   if (!target.matches("button[data-tab]")) return

   // cycling through "dataset", tab-n-1", "tab-n-2", etc. and setting
   // class to active where the target.dataset equals the class
   nav_tab_elms.forEach(elTab => {
      elTab.classList
      .toggle("active", (elTab.dataset.tab===target.dataset.tab))
   })
};


// ILEARN/IREAD
k8navTabs.onclick = ({target}) => {
   if (!target.matches("button[data-k8tab]")) return
   k8nav_tab_elms.forEach(elTab => {
      elTab.classList
      .toggle("active", (elTab.dataset.k8tab===target.dataset.k8tab))
   })
};


// Graduation Rate/SAT
hsnavTabs.onclick = ({target}) => {
   if (!target.matches("button[data-hstab]")) return
   hsnav_tab_elms.forEach(elTab => {
      elTab.classList
      .toggle("active", (elTab.dataset.hstab===target.dataset.hstab))
   })
};


// School type
typenavTabs.onclick = ({target}) => {
   if (!target.matches("button[data-typetab]")) return
   typenav_tab_elms.forEach(elTab => {
      elTab.classList
      .toggle("active", (elTab.dataset.typetab===target.dataset.typetab))
   })
};


// Analysis Year
analysisnavTabs.onclick = ({target}) => {
if (!target.matches("button[data-analysistab]")) return
analysisnav_tab_elms.forEach(elTab => {
   elTab.classList
   .toggle("active", (elTab.dataset.analysistab===target.dataset.analysistab))
})
};


/* App Initialization */
function setYearList(data, id) {

   let selectedYear = yearSelection;

   removeOptions(selectedYear);

   let yearValue,
      maxYear;

   let availableYears = [... new Set(data.map(o => o.Year))];

   if (id == "demographic") {
      maxYear = curDemographicYear;
   }
   else {
      maxYear = curAcademicYear;
   };

   // make sure selected Year is not greater than max academic year
   availableYears = availableYears.filter(arr => arr <= maxYear);
   availableYears.sort((a, b) => (a > b ? -1 : 1))

   if (id == "academic") {
      // TODO: temporarily removing "2020" because there is no
      // academic data for k8 - eventually need to add it back for HS
      const index = availableYears.indexOf(2020);
      if (index > -1) {
         availableYears.splice(index, 1);
      }
   }
   availableYears.forEach((year) => selectedYear.appendChild(new Option(year, year)));
};


function setCorpList (data) {
   const year = getSelectedYear();

   let yearData = data.filter(o => o.Year == Number(year));

   // remove duplicates
   let corpDropdown = yearData.filter(
      (v,i,a)=>a.findIndex(v2=>(v2["Corporation ID"]===v["Corporation ID"]))===i
   );

   corpDropdown.forEach(
      (corp) => corpSelection
      .appendChild(new Option(corp["Corporation Name"], corp["Corporation ID"]))
   );

   // initialize school list
   setSchoolList(data);
}


function setSchoolList(data) {
   let schoolDropdown = []
   let selectedValues = getSelectedValues();
   
   const pageTab = selectedValues.page_tab;
   const year = getSelectedYear();
   const corpID = getCorpSelection();

   let yearData = data.filter(o => o.Year == Number(year));

   schoolDropdown = yearData.filter(obj => obj["Corporation ID"] == corpID)

   // clears school dropdown element before rebuilding
   removeOptions(schoolSelection);

   schoolDropdown.forEach(
      (school) => schoolSelection
      .appendChild(new Option(school["School Name"], school["School ID"]))
   );

   // load comparison schools
   if (pageTab === "analysisTab") {
      getComparisonSchools(selectedValues);
   };

   // TODO: Should this be outside of the function??
   // auto trigger change event whenever School List changes
   var event = new Event("change");
   schoolSelection.dispatchEvent(event);
};


/// Comparison List
function setComparisonList(data) {
   
   let subset = data.map(({ ["School ID"]: value, ["School Name"]: text }) => ({ text, value }));
   
   // remove selected school from dropdown
   subset = subset.slice(1);

   // set list of available comparison schools
   comparisonSelect.setData([]);
   comparisonSelect.setData(subset);

   // as default, select first 4 (closest) schools
   let initialSelections = subset.map(function (obj) {
      return obj.value;
   });

   initialSelections = initialSelections.slice(0, 4);
   comparisonSelect.setSelected(initialSelections);
};


/* Flask calls */
// demographic data
async function getDemographicData(select) {
   const fetchedData = await fetch(`${window.origin}/demographic`, {
      method: "POST",
         credentials: "include",
         cache: "no-cache",
         headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
      },
      body:JSON.stringify(select)})
      .then(response=>{
         if (response.ok) {
            return response.json()
         } else {
            alert("Network Error: Could not load data.")
         }
      });

   let demData = fetchedData[0];
   demographicsPage(demData, select);
}


// academic information data
async function getAcademicInfoData(select) {
   const fetchedData = await fetch(`${window.origin}/academic`, {
      method: "POST",
         credentials: "include",
         cache: "no-cache",
         headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
      },
      body:JSON.stringify(select)})
      .then(response=>{
         if (response.ok) {
            return response.json()
         } else {
            alert("Network Error: Could not load data.")
         }
      })

      let infoData = fetchedData[0];
      academicInfoPage(infoData);
}


// academic analysis Data
async function getAcademicAnalysisData(select) {

   const fetchedData = await fetch(`${window.origin}/academic`, {
      method: "POST",
      headers: {
            "Content-type": "application/json",
            "Accept": "application/json"
      },
      body:JSON.stringify(select)
   })
   .then(response=>{
      if (response.ok) {
         return response.json()
      } else {
         alert("Network Error: Could not load data.")
      }
   });
   let analysisData = fetchedData[0]
   academicAnalysisPage(analysisData)
};


// comparison dropdown
async function getComparisonSchools(select) {
   const comparisonSchoolList = await fetch(`${window.origin}/where`, {
      method: "POST",
      headers: {
            "Content-type": "application/json",
            "Accept": "application/json"
      },
      body:JSON.stringify(select)})
      .then(response=>{
         if (response.ok) {
            return response.json()
         } else {
            alert("Network Error: Could not load data.")
         }
      })

      setComparisonList(comparisonSchoolList)
}

/* Pages */

// Demographic
function demographicsPage(data, select) {
   const schoolId = select.school_id;
   const year = select.year;
   
   let schoolData = data.filter((ele) => ele["School ID"] === Number(schoolId));
   let corpData = data.filter((ele) => ele["School ID"] != Number(schoolId));

   // number of years to limit data - each element in the array
   // represents one year in descending order- so we want to
   // remove elements from the front of the array to get array
   // size to yearLimit
   const yearLimit = 5;

   const yearsToRemove = schoolData.length - yearLimit;
   
   if (yearsToRemove > 0 ) {
      schoolData = dropElements(schoolData, yearsToRemove);
      corpData = dropElements(corpData, yearsToRemove);
   };

   const curYearSchoolDemographics = schoolData.filter((ele) => ele.Year === Number(year))[0];
   const curYearCorpDemographics = corpData.filter((ele) => ele.Year === Number(year))[0];

   // enrollment table data //
   var enrollmentTableObj = Object.entries(curYearSchoolDemographics).reduce((acc, [key, value]) => {
      if (
         (key.startsWith("Grade") && value === 0) ||
         (
            (!key.startsWith("Grade")) && (!key.startsWith("Total"))
         )) {
         return { ...acc };
      }
      return { ...acc, [key]: value };
   }, {});

   // this is the weird as shit way that you rename stuff in js
   delete Object.assign(enrollmentTableObj,
      {["Total"]: enrollmentTableObj["Total Enrollment"]})["Total Enrollment"];

   removeItemsByValue(enrollmentTableObj,"0")

   var enrollmentTableData = Object.keys(enrollmentTableObj)
      .map(key => ({grade: key, enrollment: enrollmentTableObj[key]}));

   // numerically sort the list of grades using only the number part of the string (Grade 5)
   enrollmentTableData.sort((a,b) => parseInt(a.grade.slice(6)) - parseInt(b.grade.slice(6)));

   // enrollment chart
   let keep = ["Year","Total Enrollment"];

   var enrollmentChartData = filterObj(schoolData, keep);

   // attendance and chronic absenteeism
   keep = ["Year","Attendance Rate", "Chronic Absenteeism %"];
   var attendanceChartData = filterObj(schoolData, keep);

   let attChartkeys = getKeys(attendanceChartData);
   const attChartcols = attChartkeys.filter(e => e !== "Year");
   attendanceChartData["columns"] = attChartcols;

   let attendanceTableData = transposeData(attendanceChartData, "Year");

   // demographic chart data //
   const ethnicityCategories = ethnicity.concat(["School Name", "Total Enrollment"]);
   const statusCategories = subgroup.concat(["School Name", "Total Enrollment"]);

   let ethnicityYearSchool = filterCategories(curYearSchoolDemographics, ethnicityCategories);
   let ethnicityYearCorp = filterCategories(curYearCorpDemographics, ethnicityCategories);
   let statusYearSchool = filterCategories(curYearSchoolDemographics, statusCategories);
   let statusYearCorp = filterCategories(curYearCorpDemographics, statusCategories);

   // inputs: entity data; array of categories; the value we are finding percentage of,
   // and min percentage to include in final data
   findPercentage(ethnicityYearSchool, ethnicity, ethnicityYearSchool["Total Enrollment"], .005);
   findPercentage(ethnicityYearCorp, ethnicity, ethnicityYearCorp["Total Enrollment"], 0);
   findPercentage(statusYearSchool, subgroup, statusYearSchool["Total Enrollment"], .005);
   findPercentage(statusYearCorp, subgroup, statusYearCorp["Total Enrollment"], 0);

   // create a string with missing categories if such categories exist
   // and then remove missing data keys
   var missingEthnicityString = findMissing(ethnicityYearSchool, ethnicityYearCorp);
   var missingStatusString = findMissing(statusYearSchool, statusYearCorp);

   // merge school and corp objects
   let ethnicityArray = [ethnicityYearSchool];
   ethnicityArray.push(ethnicityYearCorp);

   let ethnicityTransposed = transposeData(ethnicityArray, "School Name");
   var ethnicityDemoChartData = processBarData(ethnicityTransposed);

   let statusArray = [statusYearSchool];
   statusArray.push(statusYearCorp);

   let statusTransposed = transposeData(statusArray, "School Name");
   var statusDemoChartData = processBarData(statusTransposed);

   // initialize page
   if (!demographicsPage.initialize) {

      // Enrollment Table
      let enrollmentTableOptions = createEnrollmentTable(enrollmentTableData);
      const enrollmentTableGridDiv = document.querySelector("#enrollmentTable");
      enrollmentTableGridApi = agGrid.createGrid(enrollmentTableGridDiv, enrollmentTableOptions);

      // Enrollment Chart
      enrollmentChart = singleLine().data(enrollmentChartData).id("enrollmentChart");
      d3.select("#enrollmentChart").call(enrollmentChart);

      // Chronic Absenteeism and Attendance Rate Table
      let attendanceTableOptions = createBasicTable(attendanceTableData);
      const attendanceTableGridDiv = document.querySelector("#attendanceTable");
      attendanceTableGridApi = agGrid.createGrid(attendanceTableGridDiv, attendanceTableOptions);

      // Chronic Absenteeism and Attendance Rate Chart
      attendanceChart = multiLine().data(attendanceChartData).id("attendanceChart");
      d3.select("#attendanceChart").call(attendanceChart);

      // Demographics Bar Chart - Ethnicity
      ethnicityDemoChart = horizontalGroupBar().data([ethnicityDemoChartData,missingEthnicityString]).id("ethnicityDemoChart");
      d3.select("#ethnicityDemoChart").call(ethnicityDemoChart);

      // Demographics Bar Chart - Subgroup
      statusDemoChart = horizontalGroupBar().data([statusDemoChartData,missingStatusString]).id("statusDemoChart");
      d3.select("#statusDemoChart").call(statusDemoChart);

      demographicsPage.initialize = true;
   }
   else {   // update page
      let enrollmentTableOptions = createEnrollmentTable(enrollmentTableData);
      enrollmentTableGridApi.setGridOption("columnDefs", enrollmentTableOptions.columnDefs);
      enrollmentTableGridApi.setGridOption("rowData", enrollmentTableData);
      enrollmentChart.data(enrollmentChartData).id("enrollmentChart");

      let attendanceTableOptions = createBasicTable(attendanceTableData);
      attendanceTableGridApi.setGridOption("columnDefs", attendanceTableOptions.columnDefs);
      attendanceTableGridApi.setGridOption("rowData", attendanceTableData);
      attendanceChart.data(attendanceChartData).id("attendanceChart");

      ethnicityDemoChart.data([ethnicityDemoChartData,missingEthnicityString]).id("ethnicityDemoChart");
      statusDemoChart.data([statusDemoChartData,missingStatusString]).id("statusDemoChart");
   };
};

// Academic Information
function academicInfoPage(data) {

   let selection = getSelectedValues();

// TODO: HANDLE BLANK TABLE
   if (!Array.isArray(data) || !data.length) {
      console.log("NO DATA")
      console.log(data)
   }

   // if first school in list is K12, we need to manually set sub_type on initial load
   if (selection.school_type == "K12" && selection.school_subtype == "K12") {
      selection.school_subtype = "K8"
   }

   const year = selection.year;
   const schoolType = selection.school_type
   const schoolSubtype = selection.school_subtype
   const pageTab = selection.page_tab
   const typeTab = selection.type_tab
   const k8Tab = selection.k8_tab
   const hsTab = selection.hs_tab

   let subject;
   let ireadlabels = document.querySelectorAll('[id^="info-container-iread-label"]');
   let ilearnLabels = document.querySelectorAll('[id^="info-container-ilearn-label"]');
   let gradLabels = document.querySelectorAll('[id^="info-container-gradrate-label"]');
   let satLabels = document.querySelectorAll('[id^="info-container-sat-label"]');

   // set subject, type, and chart labels
   if (schoolType == "K8" || (schoolType == "K12" && schoolSubtype == "K8")) {
      if (k8Tab == "ireadTab") {  

         subject =  ["IREAD", "IREAD", "IREAD"];

         ireadlabels.forEach((el, i) => {
            let ireadLabel = subject[0] + " " + IREADLabelSuffixes[i];
            el.firstChild.textContent = ireadLabel;

         });
      }
      else {

         subject = ["ELA", "ELA", "ELA", "Math", "Math", "Math"]

         ilearnLabels.forEach((el, i) => {
            let ilearnLabel = subject[i] + " " + ilearnLabelSuffixes[i];
            el.firstChild.textContent = ilearnLabel;
         });
      }
   }
   else if (
      schoolType == "HS" || schoolType == "AHS" || 
      (schoolType == "K12" && schoolSubtype == "HS")
   ) {

      if (hsTab == "gradTab") {   

         subject = ["Graduation", "Graduation", "Graduation"];

         gradLabels.forEach((el, i) => {
            let gradLabel = subject[i] + " " + gradLabelSuffixes[i];
            el.firstChild.textContent = gradLabel;
         });
      }
      else {
         
         subject = ["EBRW", "EBRW", "EBRW", "Math", "Math", "Math"];

         satLabels.forEach((el, i) => {
            let satLabel = "SAT" + " " + subject[i] + " " + satLabelSuffixes[i];
            el.firstChild.textContent = satLabel;
         });
      }
   };

   let infoTableNames = [...document.querySelectorAll('[id^="info-"][id*="table"]:not([id*="container"])')].map(item => item.id);

   if (!academicInfoPage.initialize) {

// TODO: Load blank info tables       
      const defaultInfoData = [
         [
            "Total",
            [
               [
                  "Default School", 0
               ]
            ]
         ],
         [
            {
               color: "#ffffff",
               school: "Default School"
            }
         ]
      ];

      let id, name;

      ireadInfoTotal = multiLine().data(getChartData(data, total, "IREAD", selection)).id("ireadInfoTotal");
      d3.select("#ireadInfoTotal").call(ireadInfoTotal);

      ireadInfoEthnicity = multiLine().data(getChartData(data, ethnicity, "IREAD", selection)).id("ireadInfoEthnicity");
      d3.select("#ireadInfoEthnicity").call(ireadInfoEthnicity);

      ireadInfoSubgroup = multiLine().data(getChartData(data, subgroup, "IREAD", selection)).id("ireadInfoSubgroup");
      d3.select("#ireadInfoSubgroup").call(ireadInfoSubgroup);

      elaIlearnInfoGrade = multiLine().data(getChartData(data, gradeAll, "ELA", selection)).id("elaIlearnInfoGrade");
      d3.select("#elaIlearnInfoGrade").call(elaIlearnInfoGrade);

      elaIlearnInfoStackGrade = horizontalStackedBar().data(getProficiencyBreakdown(data, gradeAll, "ELA", selection)).id("elaIlearnInfoStackGrade");
      d3.select("#elaIlearnInfoStackGrade").call(elaIlearnInfoStackGrade);

      elaIlearnInfoEthnicity = multiLine().data(getChartData(data, ethnicity, "ELA", selection)).id("elaIlearnInfoEthnicity");
      d3.select("#elaIlearnInfoEthnicity").call(elaIlearnInfoEthnicity);

      elaIlearnInfoStackEthnicity = horizontalStackedBar().data(getProficiencyBreakdown(data, ethnicity, "ELA", selection)).id("elaIlearnInfoStackEthnicity");
      d3.select("#elaIlearnInfoStackEthnicity").call(elaIlearnInfoStackEthnicity);

      elaIlearnInfoSubgroup = multiLine().data(getChartData(data, subgroup, "ELA", selection)).id("elaIlearnInfoSubgroup");
      d3.select("#elaIlearnInfoSubgroup").call(elaIlearnInfoSubgroup);

      elaIlearnInfoStackSubgroup = horizontalStackedBar().data(getProficiencyBreakdown(data, subgroup, "ELA", selection)).id("elaIlearnInfoStackSubgroup");
      d3.select("#elaIlearnInfoStackSubgroup").call(elaIlearnInfoStackSubgroup);

      mathIlearnInfoGrade = multiLine().data(getChartData(data, gradeAll, "Math", selection)).id("mathIlearnInfoGrade");
      d3.select("#mathIlearnInfoGrade").call(mathIlearnInfoGrade);

      mathIlearnInfoStackGrade = horizontalStackedBar().data(getProficiencyBreakdown(data, gradeAll, "Math", selection)).id("mathIlearnInfoStackGrade");
      d3.select("#mathIlearnInfoStackGrade").call(mathIlearnInfoStackGrade);

      mathIlearnInfoEthnicity = multiLine().data(getChartData(data, ethnicity, "Math", selection)).id("mathIlearnInfoEthnicity");
      d3.select("#mathIlearnInfoEthnicity").call(mathIlearnInfoEthnicity);

      mathIlearnInfoStackEthnicity = horizontalStackedBar().data(getProficiencyBreakdown(data, ethnicity, "Math", selection)).id("mathIlearnInfoStackEthnicity");
      d3.select("#mathIlearnInfoStackEthnicity").call(mathIlearnInfoStackEthnicity);

      mathIlearnInfoSubgroup = multiLine().data(getChartData(data, subgroup, "Math", selection)).id("mathIlearnInfoSubgroup");
      d3.select("#mathIlearnInfoSubgroup").call(mathIlearnInfoSubgroup);

      mathIlearnInfoStackSubgroup = horizontalStackedBar().data(getProficiencyBreakdown(data, subgroup, "Math", selection)).id("mathIlearnInfoStackSubgroup");
      d3.select("#mathIlearnInfoStackSubgroup").call(mathIlearnInfoStackSubgroup);

      gradRateInfoTotal = multiLine().data(getChartData(data, gradTotal, "Graduation", selection)).id("gradRateInfoTotal");
      d3.select("#gradRateInfoTotal").call(gradRateInfoTotal);

      gradRateInfoEthnicity = multiLine().data(getChartData(data, ethnicity, "Graduation", selection)).id("gradRateInfoEthnicity");
      d3.select("#gradRateInfoEthnicity").call(gradRateInfoEthnicity);

      gradRateInfoSubgroup = multiLine().data(getChartData(data, subgroup, "Graduation", selection)).id("gradRateInfoSubgroup");
      d3.select("#gradRateInfoSubgroup").call(gradRateInfoSubgroup);

      ebrwSatInfoTotal = multiLine().data(getChartData(data, total, "EBRW", selection)).id("ebrwSatInfoTotal");
      d3.select("#ebrwSatInfoTotal").call(ebrwSatInfoTotal);

      ebrwSatInfoEthnicity = multiLine().data(getChartData(data, ethnicity, "EBRW", selection)).id("ebrwSatInfoEthnicity");
      d3.select("#ebrwSatInfoEthnicity").call(ebrwSatInfoEthnicity);

      ebrwSatInfoSubgroup = multiLine().data(getChartData(data, subgroup, "EBRW", selection)).id("ebrwSatInfoSubgroup");
      d3.select("#ebrwSatInfoSubgroup").call(ebrwSatInfoSubgroup);

      mathSatInfoTotal = multiLine().data(getChartData(data, total, "Math", selection)).id("mathSatInfoTotal");
      d3.select("#mathSatInfoTotal").call(mathSatInfoTotal);

      mathSatInfoEthnicity = multiLine().data(getChartData(data, ethnicity, "Math", selection)).id("mathSatInfoEthnicity");
      d3.select("#mathSatInfoEthnicity").call(mathSatInfoEthnicity);

      mathSatInfoSubgroup = multiLine().data(getChartData(data, subgroup, "Math", selection)).id("mathSatInfoSubgroup");
      d3.select("#mathSatInfoSubgroup").call(mathSatInfoSubgroup);

// Tables
// https://www.ag-grid.com/javascript-data-grid/grid-api/
// https://javascript.plainenglish.io/angular-how-can-you-clear-the-references-of-multiple-ag-grid-tables-together-353610b0c126
// https://stackoverflow.com/questions/67917738/multiple-ag-grids-setselected-to-true-is-only-working-for-the-last-grid
// https://stackoverflow.com/questions/53920531/can-we-change-the-view-for-ag-grid-in-mobile-devices

      // Initialize (empty) tables on-load
      for (let k = 0; k < infoTableNames.length; k++) {
         let infoTableID = "#" + infoTableNames[k]
         let infoTableOptions = initializeTable(infoTableID)
         var infoGridDiv = document.querySelector(infoTableID)
         infoGridApi[k] = agGrid.createGrid(infoGridDiv, infoTableOptions);
      }

      academicInfoPage.initialize = true;

   }
   else {      
      
      /* Update */

      let infoStartingIndex,
         infoCategories,
         infoSubjects;

      if (typeTab == "k8Tab") {
         if (k8Tab == "ireadTab") {
            infoStartingIndex = 0;
            infoSubjects = ["IREAD", "IREAD", "IREAD"];
            infoCategories = [total, ethnicity, subgroup];

            ireadInfoTotal.data(getChartData(data, infoCategories[0], infoSubjects[0], selection)).id("ireadInfoTotal");
            ireadInfoEthnicity.data(getChartData(data, infoCategories[1], infoSubjects[1], selection)).id("ireadInfoEthnicity");
            ireadInfoSubgroup.data(getChartData(data, infoCategories[2], infoSubjects[2], selection)).id("ireadInfoSubgroup");         
         }
         else {
            infoStartingIndex = 3;
            infoSubjects = ["ELA", "ELA", "ELA", "Math", "Math", "Math"];
            infoCategories = [gradeAll, ethnicity, subgroup, gradeAll, ethnicity, subgroup];

            elaIlearnInfoGrade.data(getChartData(data, infoCategories[0], infoSubjects[0], selection)).id("elaIlearnInfoGrade");
            elaIlearnInfoEthnicity.data(getChartData(data, infoCategories[1], infoSubjects[1], selection)).id("elaIlearnInfoEthnicity");
            elaIlearnInfoSubgroup.data(getChartData(data, infoCategories[2], infoSubjects[2], selection)).id("elaIlearnInfoSubgroup");
            mathIlearnInfoGrade.data(getChartData(data, infoCategories[3], infoSubjects[3], selection)).id("mathIlearnInfoGrade");
            mathIlearnInfoEthnicity.data(getChartData(data, infoCategories[4], infoSubjects[4], selection)).id("mathIlearnInfoEthnicity");
            mathIlearnInfoSubgroup.data(getChartData(data, infoCategories[5], infoSubjects[5], selection)).id("mathIlearnInfoSubgroup");

            elaIlearnInfoStackGrade.data(getProficiencyBreakdown(data, infoCategories[0], infoSubjects[0], selection)).id("elaIlearnInfoStackGrade");
            elaIlearnInfoStackSubgroup.data(getProficiencyBreakdown(data, infoCategories[1], infoSubjects[1], selection)).id("elaIlearnInfoStackSubgroup");
            elaIlearnInfoStackEthnicity.data(getProficiencyBreakdown(data, infoCategories[2], infoSubjects[2], selection)).id("elaIlearnInfoStackEthnicity");
            mathIlearnInfoStackGrade.data(getProficiencyBreakdown(data, infoCategories[3], infoSubjects[3], selection)).id("mathIlearnInfoStackGrade");
            mathIlearnInfoStackEthnicity.data(getProficiencyBreakdown(data, infoCategories[4], infoSubjects[4], selection)).id("mathIlearnInfoStackEthnicity");
            mathIlearnInfoStackSubgroup.data(getProficiencyBreakdown(data, infoCategories[5], infoSubjects[5], selection)).id("mathIlearnInfoStackSubgroup");              
         }
      }
      else if (typeTab == "hsTab") {
         if (hsTab == "gradTab") {
            infoStartingIndex = 9;
            infoSubjects = ["Graduation", "Graduation", "Graduation"];
            infoCategories = [gradTotal, ethnicity, subgroup];

            gradRateInfoTotal.data(getChartData(data, infoCategories[0], infoSubjects, selection)).id("gradRateInfoTotal");
            gradRateInfoEthnicity.data(getChartData(data, infoCategories[1], infoSubjects, selection)).id("gradRateInfoEthnicity");
            gradRateInfoSubgroup.data(getChartData(data, infoCategories[2], infoSubjects, selection)).id("gradRateInfoSubgroup");
         }
         else if (hsTab == "satTab") {
            infoStartingIndex = 12;
            infoSubjects = ["EBRW", "EBRW", "EBRW", "Math", "Math", "Math"];
            infoCategories = [total, ethnicity, subgroup, total, ethnicity, subgroup];

            ebrwSatInfoTotal.data(getChartData(data, infoCategories[0], infoSubjects[0], selection)).id("ebrwSatInfoTotal");
            ebrwSatInfoEthnicity.data(getChartData(data, infoCategories[1], infoSubjects[1], selection)).id("ebrwSatInfoEthnicity");
            ebrwSatInfoSubgroup.data(getChartData(data, infoCategories[2], infoSubjects[2], selection)).id("ebrwSatInfoSubgroup");
            mathSatInfoTotal.data(getChartData(data, infoCategories[3], infoSubjects[3], selection)).id("mathSatInfoTotal");
            mathSatInfoEthnicity.data(getChartData(data, infoCategories[4], infoSubjects[4], selection)).id("mathSatInfoEthnicity");
            mathSatInfoSubgroup.data(getChartData(data, infoCategories[5], infoSubjects[5], selection)).id("mathSatInfoSubgroup");
         }
      };

      /* Update Tables */
      //https://www.ag-grid.com/javascript-data-grid/data-update-row-data/
      // TODO: This seems Kludgy as hell. Loops through array of grids (using a
      // global variable gridAPI) and using the gridDivID to determine which data to use.
      let infoTableData, infoTableID;


      // Remove objects with years > the selected year
      const tabledata = data.filter((obj, index) => !(obj.Year > Number(year)));

      for (let i=0; i < infoSubjects.length; i++) {

         let infoTableNum = i + infoStartingIndex;

         infoTableID = infoGridApi[infoTableNum].getGridId();
         infoTableData = getTableData(tabledata, infoCategories[i], subject[i], selection);

         // TODO: Figure out why this doesn't include tableID but createanalysisTable does
         let infoTableOptions = createInfoTable(infoTableData, infoTableID)

         // need to reset columndefs as well as rowdata or else table
         // will have empty cols.
         infoGridApi[infoTableNum].setGridOption("columnDefs", infoTableOptions.columnDefs);
         infoGridApi[infoTableNum].setGridOption("rowData", infoTableData);
      };
   }
};


// Chart Academic Information
function academicAnalysisPage(data) {

   let selection = getSelectedValues();

   const year = selection.year;
   const schoolType = selection.school_type
   const schoolSubtype = selection.school_subtype
   const schoolID = selection.school_id
   const pageTab = selection.page_tab
   const typeTab = selection.type_tab
   const k8Tab = selection.k8_tab
   const hsTab = selection.hs_tab

   let subject;
   let newColors = [];
   let usedColors = [];
   let remainingColors = [];

   console.log("ACADEMIC ANALYSIS Main Function")
   
   // set subject based on selected tab
   if (
      schoolType == "K8" ||
      (schoolType == "K12" && (schoolSubtype == "K8" || schoolSubtype == "K12")) ||
      (typeof schoolType === "undefined" && typeof schoolSubtype === "undefined")
      ) {
      if (k8Tab == "ireadTab") {
         subject =  subjectIread
      }
      else {
         subject = subjectIlearn
      }
   }
   else if (
      schoolType == "HS" || schoolType == "AHS" || 
      (schoolType == "K12" && schoolSubtype == "HS")
   ) {
      if (hsTab == "gradTab") { subject = subjectGrad }
      else { subject = subjectSAT; }
   };

   // Single Year Analysis Page //
   let yearData = data.filter(o => o.Year == Number(year));

   const schoolName = yearData.find(d => d["School ID"] === schoolID)["School Name"];

   // add color to each school dict
   yearData.forEach((obj, idx) => {
      obj.color = colorList[idx];
   });

   // NOTE: Because the user can add and remove schools, we need a way to ensure that
   // colors remain consistent both from chart to chart and between updates- we do
   // this by using a global variable ("colorState") which stores the school:color
   // pairs immediately prior to an update and then using it to determine which
   // schools were added or dropped.
   newColors = yearData.map(function (obj) {
      return  {
         school: obj["School Name"],
         color: obj.color
      }
   });

   // See: https://stackoverflow.com/questions/21987909/how-to-get-the-difference-between-two-arrays-of-objects-in-javascript
   // using answer provided by "pantaflex44"
   const addSchool = newColors.filter(({ school: id1 }) => !colorState.some(({ school: id2 }) => id2 === id1));
   const removeSchool = colorState.filter(({ school: id1 }) => !newColors.some(({ school: id2 }) => id2 === id1));
   
   usedColors = colorState.map(function (obj) { return  obj.color});
   remainingColors = colorList.filter(x => !usedColors.includes(x));

   // on first load of academic page (initial load of app is
   // single school- initial load of academic tab adds 4 more schools, only
   // time addSchool should be more than 1)
   if (Array.isArray(addSchool) && addSchool.length > 1) {
      colorState = newColors;
   } 
   // school added
   else if (Array.isArray(addSchool) && addSchool.length) {
      colorState.push({school: addSchool[0].school, color: remainingColors[0]}) 
   }
   // school removed
   else if (Array.isArray(removeSchool) && removeSchool.length) {
      const pos = colorState.findIndex(el => el.school === removeSchool[0].school);
      if (pos >= 0)
         colorState.splice(pos, 1);
   };

   // the selected school is always the same color- hopefully one that
   // stands out- currently using #1c39bb (Persian Blue)
   // other options: #0033aa (UA Blue); #002fa7 (International Klein Blue);
   // #0047ab (Cobalt); #002147 (Oxford Blue)
   Object.assign(
      colorState.find(({school, color}) => school === schoolName),
         {school: schoolName, color: "#1c39bb"}
   );

   const yearString = longYear(year);

   // Set Table Names [[ TODO: Why not just hardcode in html?? ]]
   let ireadTotalLabel = document.getElementById("analysis-container-iread-label-1");
   ireadTotalLabel.firstChild.textContent = "Current Year IREAD Proficiency (" + yearString + ")";
   let ireadEthnicityLabel = document.getElementById("analysis-container-iread-label-2");
   ireadEthnicityLabel.firstChild.textContent = "Current Year IREAD Proficiency by Ethnicity(" + yearString + ")";         
   let ireadSubgroupLabel = document.getElementById("analysis-container-iread-label-3");
   ireadSubgroupLabel.firstChild.textContent = "Current Year IREAD Proficiency by Subgroup (" + yearString + ")";
   let elaILEARNTotalLabel = document.getElementById("analysis-container-ilearn-label-4");
   elaILEARNTotalLabel.firstChild.textContent = "Current Year ELA Proficiency (" + yearString + ")";
   let elaGradeLabel = document.getElementById("analysis-container-ilearn-label-5");
   elaGradeLabel.firstChild.textContent = "Current Year ELA Proficiency by Grade (" + yearString + ")";
   let elaILEARNGradethnicityLabel = document.getElementById("analysis-container-ilearn-label-6");
   elaILEARNGradethnicityLabel.firstChild.textContent = "Current Year ELA Proficiency by Ethnicity (" + yearString + ")";
   let elaILEARNSubgroupLabel = document.getElementById("analysis-container-ilearn-label-7");
   elaILEARNSubgroupLabel.firstChild.textContent = "Current Year ELA Proficiency by Subgroup (" + yearString + ")";
   let mathILEARNTotalLabel = document.getElementById("analysis-container-ilearn-label-8");
   mathILEARNTotalLabel.firstChild.textContent = "Current Year Math Proficiency (" + yearString + ")";
   let mathGradeLabel = document.getElementById("analysis-container-ilearn-label-9");
   mathGradeLabel.firstChild.textContent = "Current Year Math Proficiency by Grade (" + yearString + ")";
   let mathILEARNEthnicityLabel = document.getElementById("analysis-container-ilearn-label-10");
   mathILEARNEthnicityLabel.firstChild.textContent = "Current Year Math Proficiency by Ethnicity (" + yearString + ")";
   let mathILEARNSubgroupLabel = document.getElementById("analysis-container-ilearn-label-11");
   mathILEARNSubgroupLabel.firstChild.textContent = "Current Year Math Proficiency by Subgroup (" + yearString + ")";
   let gradRateTotalLabel = document.getElementById("analysis-container-gradrate-label-12");
   gradRateTotalLabel.firstChild.textContent = "Current Year Graduation Rate (" + yearString + ")";
   let gradRateEthnicityLabel = document.getElementById("analysis-container-gradrate-label-13");
   gradRateEthnicityLabel.firstChild.textContent = "Current Year Graduation Rate by Ethnicity (" + yearString + ")";
   let gradRateSubgroupLabel = document.getElementById("analysis-container-gradrate-label-14");
   gradRateSubgroupLabel.firstChild.textContent = "Current Year Graduation Rate by Subgroup (" + yearString + ")";
   let satTotalLabel = document.getElementById("analysis-container-sat-label-15");
   satTotalLabel.firstChild.textContent = "Current Year SAT Proficiency (" + yearString + ")";
   let satEthnicityLabel = document.getElementById("analysis-container-sat-label-16");
   satEthnicityLabel.firstChild.textContent = "Current Year SAT Proficiency by Ethnicity (" + yearString + ")";
   let satSubgroupLabel = document.getElementById("analysis-container-sat-label-17");
   satSubgroupLabel.firstChild.textContent = "Current Year SAT Proficiency by Subgroup (" + yearString + ")";

   // get table names from document (querySelector returns a collection,
   // so we use spread syntax and map to get ids as a list)
   let analysisTableNames = [...document.querySelectorAll('[id^="analysis-"][id*="table"]:not([id*="container"])')].map(item => item.id);
   
   if (!academicAnalysisPage.initialize){

      console.log("INITIALIZINGINS")

      // On load, initialize all tables and charts as empty (using dummy data).
      const defaultData = [
         [
            "Total",
            [
               [
                  "Default School", 0
               ]
            ]
         ],
         [
            {
               color: "#ffffff",
               school: "Default School"
            }
         ]
      ];
      
      ireadComparisonTotal = verticalGroupBar().data(defaultData).id("ireadComparisonTotal");
      d3.select("#ireadComparisonTotal").call(ireadComparisonTotal);

      ireadComparisonEthnicity = verticalGroupBar().data(defaultData).id("ireadComparisonEthnicity");
      d3.select("#ireadComparisonEthnicity").call(ireadComparisonEthnicity);

      ireadComparisonSubgroup = verticalGroupBar().data(defaultData).id("ireadComparisonSubgroup");
      d3.select("#ireadComparisonSubgroup").call(ireadComparisonSubgroup);

      elaILEARNComparisonTotal = verticalGroupBar().data(defaultData).id("elaILEARNComparisonTotal");
      d3.select("#elaILEARNComparisonTotal").call(elaILEARNComparisonTotal);

      elaILEARNComparisonGrade = verticalGroupBar().data(defaultData).id("elaILEARNComparisonGrade");
      d3.select("#elaILEARNComparisonGrade").call(elaILEARNComparisonGrade);

      elaILEARNComparisonEthnicity = verticalGroupBar().data(defaultData).id("elaILEARNComparisonEthnicity");
      d3.select("#elaILEARNComparisonEthnicity").call(elaILEARNComparisonEthnicity);

      elaILEARNComparisonSubgroup = verticalGroupBar().data(defaultData).id("elaILEARNComparisonSubgroup");
      d3.select("#elaILEARNComparisonSubgroup").call(elaILEARNComparisonSubgroup);

      mathILEARNComparisonTotal = verticalGroupBar().data(defaultData).id("mathILEARNComparisonTotal");
      d3.select("#mathILEARNComparisonTotal").call(mathILEARNComparisonTotal);

      mathILEARNComparisonGrade = verticalGroupBar().data(defaultData).id("mathILEARNComparisonGrade");
      d3.select("#mathILEARNComparisonGrade").call(mathILEARNComparisonGrade);

      mathILEARNComparisonEthnicity = verticalGroupBar().data(defaultData).id("mathILEARNComparisonEthnicity");
      d3.select("#mathILEARNComparisonEthnicity").call(mathILEARNComparisonEthnicity);

      mathILEARNComparisonSubgroup = verticalGroupBar().data(defaultData).id("mathILEARNComparisonSubgroup");
      d3.select("#mathILEARNComparisonSubgroup").call(mathILEARNComparisonSubgroup);

      gradRateComparisonTotal = verticalGroupBar().data(defaultData).id("gradRateComparisonTotal");
      d3.select("#gradRateComparisonTotal").call(gradRateComparisonTotal);

      gradRateComparisonEthnicity = verticalGroupBar().data(defaultData).id("gradRateComparisonEthnicity");
      d3.select("#gradRateComparisonEthnicity").call(gradRateComparisonEthnicity);

      gradRateComparisonSubgroup = verticalGroupBar().data(defaultData).id("gradRateComparisonSubgroup");
      d3.select("#gradRateComparisonSubgroup").call(gradRateComparisonSubgroup);      

      satComparisonTotal = verticalGroupBar().data(defaultData).id("satComparisonTotal");
      d3.select("#satComparisonTotal").call(satComparisonTotal);

      satComparisonEthnicity = verticalGroupBar().data(defaultData).id("satComparisonEthnicity");
      d3.select("#satComparisonEthnicity").call(satComparisonEthnicity);

      satComparisonSubgroup = verticalGroupBar().data(defaultData).id("satComparisonSubgroup");
      d3.select("#satComparisonSubgroup").call(satComparisonSubgroup); 

      for (let k = 0; k < analysisTableNames.length; k++) {
         let analysisTableName = analysisTableNames[k];
         let analysisTableID = "#" + analysisTableName;

         let analysisTableOptions = initializeTable(analysisTableID);
         var analysisGridDiv = document.querySelector(analysisTableID);
         analysisGridApi[k] = agGrid.createGrid(analysisGridDiv, analysisTableOptions);
      }

      academicAnalysisPage.initialize = true;

   } else {
      console.log("UPDATING ACADEMIC ANALYSIS")

      // Get table/chart data and build tables
      if (typeTab == "k8Tab") {
         if (k8Tab == "ireadTab") {
            // Single Year Comparison: IREAD Proficiency by Total
            let ireadTotalData = getChartData(yearData, total, "IREAD", selection)
            let ireadTotalColumns = Object.keys(ireadTotalData.find(d => d["School Name"] === schoolName));
            let ireadTotalFilteredData = filterKeys(ireadTotalData, ireadTotalColumns)
            let itreadTotalTransposedData = transposeData(ireadTotalFilteredData, "School Name");
            var ireadTotalChartData = processBarData(itreadTotalTransposedData);
            ireadTotalChartData.push(colorState)
            ireadComparisonTotal.data(ireadTotalChartData).id("ireadComparisonTotal");
            
            // Single Year Comparison: IREAD Proficiency by Ethnicity
            let ireadEthnicityData = getChartData(yearData, ethnicity, "IREAD", selection)
            let ireadEthnicityColumns = Object.keys(ireadEthnicityData.find(d => d["School Name"] === schoolName));
            let ireadEthnicityFilteredData = filterKeys(ireadEthnicityData, ireadEthnicityColumns)
            let ireadEthnicityTransposedData = transposeData(ireadEthnicityFilteredData, "School Name");
            var ireadEthnicityChartData = processBarData(ireadEthnicityTransposedData);
            ireadEthnicityChartData.push(colorState)
            ireadComparisonEthnicity.data(ireadEthnicityChartData).id("ireadComparisonEthnicity");
            
            // Single Year Comparison: IREAD Proficiency by Subgroup
            let ireadSubgroupData = getChartData(yearData, subgroup, "IREAD", selection)
            let ireadSubgroupColumns = Object.keys(ireadSubgroupData.find(d => d["School Name"] === schoolName));
            let ireadSubgroupFilteredData = filterKeys(ireadSubgroupData, ireadSubgroupColumns)
            let ireadSubgroupTransposedData = transposeData(ireadSubgroupFilteredData, "School Name");
            var ireadSubgroupChartData = processBarData(ireadSubgroupTransposedData);
            ireadSubgroupChartData.push(colorState)
            ireadComparisonSubgroup.data(ireadSubgroupChartData).id("ireadComparisonSubgroup");
         }
         else {
            // Single Year Comparison: ELA Proficiency by Total
            let elaILEARNTotalData = getChartData(yearData, total, subject[0], selection)
            let elaILEARNTotalColumns = Object.keys(elaILEARNTotalData.find(d => d["School Name"] === schoolName));
            let elaILEARNFilteredData = filterKeys(elaILEARNTotalData, elaILEARNTotalColumns)
            let elaILEARNTotalTransposedData = transposeData(elaILEARNFilteredData, "School Name");
            var elaILEARNTotalChartData = processBarData(elaILEARNTotalTransposedData);
            elaILEARNTotalChartData.push(colorState)
            elaILEARNComparisonTotal.data(elaILEARNTotalChartData).id("elaILEARNComparisonTotal");

            // Single Year Comparison: ELA Proficiency by Grade
            let elaGradeData = getChartData(yearData, grade, subject[0], selection)
            let elaGradeColumns = Object.keys(elaGradeData.find(d => d["School Name"] === schoolName));
            let elaGradeFilteredData = filterKeys(elaGradeData, elaGradeColumns)
            let elaGradeTransposedData = transposeData(elaGradeFilteredData, "School Name");
            var elaGradeChartData = processBarData(elaGradeTransposedData);
            elaGradeChartData.push(colorState)
            elaILEARNComparisonGrade.data(elaGradeChartData).id("elaILEARNComparisonGrade");

            // Single Year Comparison: ELA Proficiency by Ethnicity
            let elaILEARNGradethnicityData = getChartData(yearData, ethnicity, subject[0], selection)
            let elaILEARNGradethnicityColumns = Object.keys(elaILEARNGradethnicityData.find(d => d["School Name"] === schoolName));
            let elaILEARNGradethnicityFilteredData = filterKeys(elaILEARNGradethnicityData, elaILEARNGradethnicityColumns)
            let elaILEARNGradethnicityTransposedData = transposeData(elaILEARNGradethnicityFilteredData, "School Name");
            var elaILEARNGradethnicityChartData = processBarData(elaILEARNGradethnicityTransposedData);
            elaILEARNGradethnicityChartData.push(colorState)
            elaILEARNComparisonEthnicity.data(elaILEARNGradethnicityChartData).id("elaILEARNComparisonEthnicity");

            //Single Year Comparison: ELA Proficiency by Subgroup
            let elaILEARNSubgroupData = getChartData(yearData, subgroup, subject[0], selection)
            let elaILEARNSubgroupColumns = Object.keys(elaILEARNSubgroupData.find(d => d["School Name"] === schoolName));
            let elaILEARNSubgroupFilteredData = filterKeys(elaILEARNSubgroupData, elaILEARNSubgroupColumns)
            let elaILEARNSubgroupTransposedData = transposeData(elaILEARNSubgroupFilteredData, "School Name");
            var elaILEARNSubgroupChartData = processBarData(elaILEARNSubgroupTransposedData);
            elaILEARNSubgroupChartData.push(colorState)
            elaILEARNComparisonSubgroup.data(elaILEARNSubgroupChartData).id("elaILEARNComparisonSubgroup");

            // Single Year Comparison: Math Proficiency by Total
            let mathILEARNTotalData = getChartData(yearData, total, subject[1], selection)
            let mathILEARNTotalColumns = Object.keys(mathILEARNTotalData.find(d => d["School Name"] === schoolName));
            let mathILEARNTotalFilteredData = filterKeys(mathILEARNTotalData, mathILEARNTotalColumns)
            let mathILEARNTotalTransposedData = transposeData(mathILEARNTotalFilteredData, "School Name");
            var mathILEARNTotalChartData = processBarData(mathILEARNTotalTransposedData);
            mathILEARNTotalChartData.push(colorState)
            mathILEARNComparisonTotal.data(mathILEARNTotalChartData).id("mathILEARNComparisonTotal");

            // Single Year Comparison: Math Proficiency by Grade
            let mathGradeData = getChartData(yearData, grade, subject[0], selection)
            let mathGradeColumns = Object.keys(mathGradeData.find(d => d["School Name"] === schoolName));
            let mathGradeFilteredData = filterKeys(mathGradeData, mathGradeColumns)
            let mathGradeTransposedData = transposeData(mathGradeFilteredData, "School Name");
            var mathGradeChartData = processBarData(mathGradeTransposedData);
            mathGradeChartData.push(colorState)
            mathILEARNComparisonGrade.data(mathGradeChartData).id("mathILEARNComparisonGrade");

            // Single Year Comparison: ELA Proficiency by Ethnicity
            let mathILEARNEthnicityData = getChartData(yearData, ethnicity, subject[0], selection)
            let mathILEARNEthnicityColumns = Object.keys(mathILEARNEthnicityData.find(d => d["School Name"] === schoolName));
            let mathILEARNEthnicityFilteredData = filterKeys(mathILEARNEthnicityData, mathILEARNEthnicityColumns)
            let mathILEARNEthnicityTransposedData = transposeData(mathILEARNEthnicityFilteredData, "School Name");
            var mathILEARNEthnicityChartData = processBarData(mathILEARNEthnicityTransposedData);
            mathILEARNEthnicityChartData.push(colorState)
            mathILEARNComparisonEthnicity.data(mathILEARNEthnicityChartData).id("mathILEARNComparisonEthnicity");
            
            //Single Year Comparison: ELA Proficiency by Subgroup
            let mathILEARNSubgroupData = getChartData(yearData, subgroup, subject[0], selection)
            let mathILEARNSubgroupColumns = Object.keys(mathILEARNSubgroupData.find(d => d["School Name"] === schoolName));
            let mathILEARNSubgroupFilteredData = filterKeys(mathILEARNSubgroupData, mathILEARNSubgroupColumns)
            let mathILEARNSubgroupTransposedData = transposeData(mathILEARNSubgroupFilteredData, "School Name");
            var mathILEARNSubgroupChartData = processBarData(mathILEARNSubgroupTransposedData);
            mathILEARNSubgroupChartData.push(colorState)
            mathILEARNComparisonSubgroup.data(mathILEARNSubgroupChartData).id("mathILEARNComparisonSubgroup");
         }
      }

      if (typeTab == "hsTab")
         if (hsTab == "gradTab") {
            // Single Year Comparison: Grad Rate Total
            let gradRateTotalData = getChartData(yearData, gradTotal, subject[0], selection)
            let gradRateTotalColumns = Object.keys(gradRateTotalData.find(d => d["School Name"] === schoolName));
            let gradRateTotalFilteredData = filterKeys(gradRateTotalData, gradRateTotalColumns)
            let gradRateTotalTransposedData = transposeData(gradRateTotalFilteredData, "School Name");
            var gradRateTotalChartData = processBarData(gradRateTotalTransposedData);
            gradRateTotalChartData.push(colorState)
            gradRateComparisonTotal.data(gradRateTotalChartData).id("gradRateComparisonTotal");

            // Single Year Comparison: Grad Rate by Ethnicity
            let gradRateEthnicityData = getChartData(yearData, ethnicity, subject[0], selection)
            let gradRateEthnicityColumns = Object.keys(gradRateEthnicityData.find(d => d["School Name"] === schoolName));
            let gradRateEthnicityFilteredData = filterKeys(gradRateEthnicityData, gradRateEthnicityColumns)
            let gradRateEthnicityTransposedData = transposeData(gradRateEthnicityFilteredData, "School Name");
            var gradRateEthnicityChartData = processBarData(gradRateEthnicityTransposedData);
            gradRateEthnicityChartData.push(colorState)
            gradRateComparisonEthnicity.data(gradRateEthnicityChartData).id("gradRateComparisonEthnicity");

            //Single Year Comparison: Grad Rate by Subgroup
            let gradRateSubgroupData = getChartData(yearData, subgroup, subject[0], selection)
            let gradRateSubgroupColumns = Object.keys(gradRateSubgroupData.find(d => d["School Name"] === schoolName));
            let gradRateSubgroupFilteredData = filterKeys(gradRateSubgroupData, gradRateSubgroupColumns)
            let gradRateSubgroupTransposedData = transposeData(gradRateSubgroupFilteredData, "School Name");
            var gradRateSubgroupChartData = processBarData(gradRateSubgroupTransposedData);
            gradRateSubgroupChartData.push(colorState)
            gradRateComparisonSubgroup.data(gradRateSubgroupChartData).id("gradRateComparisonSubgroup");
         }
      else {
         // Single Year Comparison: SAT Total
         let satTotalData = getChartData(yearData, total, subject[0], selection)
         let satTotalColumns = Object.keys(satTotalData.find(d => d["School Name"] === schoolName));
         let satTotalFilteredData = filterKeys(satTotalData, satTotalColumns)
         let satTotalTransposedData = transposeData(satTotalFilteredData, "School Name");
         var satTotalChartData = processBarData(satTotalTransposedData);
         satTotalChartData.push(colorState)
         satComparisonTotal.data(satTotalChartData).id("satComparisonTotal");

         // Single Year Comparison: SAT by Ethnicity
         let satEthnicityData = getChartData(yearData, ethnicity, subject[0], selection)
         let satEthnicityColumns = Object.keys(satEthnicityData.find(d => d["School Name"] === schoolName));
         let satEthnicityFilteredData = filterKeys(satEthnicityData, satEthnicityColumns)
         let satEthnicityTransposedData = transposeData(satEthnicityFilteredData, "School Name");
         var satEthnicityChartData = processBarData(satEthnicityTransposedData);
         satEthnicityChartData.push(colorState)
         satComparisonEthnicity.data(satEthnicityChartData).id("satComparisonEthnicity");

         //Single Year Comparison: SAT by Subgroup
         let satSubgroupData = getChartData(yearData, subgroup, subject[0], selection)
         let satSubgroupColumns = Object.keys(satSubgroupData.find(d => d["School Name"] === schoolName));
         let satSubgroupFilteredData = filterKeys(satSubgroupData, satSubgroupColumns)
         let satSubgroupTransposedData = transposeData(satSubgroupFilteredData, "School Name");
         var satSubgroupChartData = processBarData(satSubgroupTransposedData);
         satSubgroupChartData.push(colorState)
         satComparisonSubgroup.data(satSubgroupChartData).id("satComparisonSubgroup");
      };

      /* Update Tables */
      let analysisTableData, analysisTableID, analysisCatList;

      // Remove objects with years > the selected year
      const tabledata = yearData.filter((obj, index) => !(obj.Year > Number(year)));
      let analysisTableSubjects, analysisTableStartingIndex, analysisTableCategories;

      if (typeTab == "k8Tab") {
         if (k8Tab == "ireadTab") {
            analysisTableStartingIndex = 0;
            analysisTableSubjects = ["IREAD", "IREAD", "IREAD"]
            analysisTableCategories = [total, ethnicity, subgroup];
         } else {
            analysisTableStartingIndex = 3;
            analysisTableSubjects = ["ELA", "ELA", "ELA", "ELA", "Math", "Math", "Math", "Math"]
            analysisTableCategories = [total, grade, ethnicity, subgroup, total, grade, ethnicity, subgroup];
         }
      } else if (typeTab == "hsTab") {
         if (hsTab == "gradTab") {
            analysisTableStartingIndex = 11;
            analysisTableSubjects = ["Graduation", "Graduation", "Graduation"]
            analysisTableCategories = [gradTotal, ethnicity, subgroup];
         }
         } else {
            analysisTableStartingIndex = 14;
            analysisTableSubjects = ["SAT", "SAT", "SAT"]
            analysisTableCategories = [total, ethnicity, subgroup];
      }

      for (let i=0; i < (analysisTableSubjects.length); i++) {
         let analysisTableNum = analysisTableStartingIndex + i

         analysisTableID = analysisGridApi[analysisTableNum].getGridId()
         analysisTableData = getAnalysisTableData(tabledata, analysisTableCategories[i], analysisTableSubjects[i], selection, colorState)

         let missingCategories = analysisTableData.pop()
         let missingString;
         if (typeof missingCategories !== 'undefined' && missingCategories.length > 0) {
            missingString = "<b>Selected school has no data for:</b> " + missingCategories.join(", ") + "."

            const msgId = analysisTableID.replace("table", "msg").replace("#","");
            let analysisMsgDiv = document.getElementById(msgId);
            analysisMsgDiv.innerHTML = missingString;
         };

         let analysisTableOptions = createAnalysisTable(analysisTableData, analysisTableID)

         // reset columndefs and rowdata or else table will have empty cols.
         analysisGridApi[analysisTableNum].setGridOption("columnDefs", analysisTableOptions.columnDefs);
         analysisGridApi[analysisTableNum].setGridOption("rowData", analysisTableData);
      }
   }
   // TODO: Multi-Year Analysis Page
};


// Navigation //
if (allnav.addEventListener) {
   allnav.addEventListener('click',navigateHandler,false);
}
else {
   allnav.addEventListener('onclick',navigateHandler);

}

function navigateHandler(e) {
   const mainSelection = document.querySelector(".tab.main.active").id;
   const k8Selection = document.querySelector(".tab.k8info.active").id;
   const hsSelection = document.querySelector(".tab.hsinfo.active").id;
   const typeSelection = document.querySelector(".tab.type.active").id;
   const analysisSelection = document.querySelector(".tab.analysis.active").id;

   const k8Categories = document.querySelector(".k8nav");
   const hsCategories = document.querySelector(".hsnav");
   const typeCategories = document.querySelector(".typenav");
   const analysisPages = document.querySelector(".analysisnav");

   // target is the button triggering the onClick
   // mainSelection is the main nav (demoTab, infoTab, analysisTab)
   // subSelection is info-k8nav (ireadTab, ilearnTab)
   // typeSelection is type nav (K8, HS)
   // target will be equal to one of the above selections
   e = e || window.event;
   var target = e.target || e.srcElement;

   var selectedValues = getSelectedValues();

   const selectedPage = selectedValues.page_tab;

   const strYear = selectedValues.year;
   const intYear = parseInt(strYear)
   let yearValue;

   const schoolType = selectedValues.school_type;
   const schoolSubtype = selectedValues.school_subtype;

   // the iread/ilearn tabs should never be visible when HS is selected
   // and should always be available when K8 is selected
   if (target.id.match("hsTab")) {
      k8Categories.classList.remove("open");
      hsCategories.classList.add("open");
   }

   if (target.id.match("k8Tab")) {
      k8Categories.classList.add("open");
      hsCategories.classList.remove("open");
   }

   // Demographic Tab //
   if (target.id.match("demoTab")) {

      k8Categories.classList.remove("open");
      hsCategories.classList.remove("open");
      typeCategories.classList.remove("open");
      analysisPages.classList.remove("open");

      setYearList(allSchoolsObj,"demographic");

      yearSelection.value = strYear;
      yearSelection.setAttribute("value", strYear);

      getDemographicData(selectedValues);

      // adjust chart size based on browser window size
      let windowWidth = window.innerWidth/2 - 125;
      enrollmentChart.width(windowWidth);
      attendanceChart.width(windowWidth);
      ethnicityDemoChart.width(windowWidth);
      statusDemoChart.width(windowWidth);      
   }
   else if (

   // Academic Information Tab and subtabs //
      target.id.match("infoTab") ||
      selectedPage.match("infoTab") &&
         (target.id.match("ilearnTab") ||
         target.id.match("ireadTab") ||
         target.id.match("k8Tab") ||
         target.id.match("hsTab") ||
         target.id.match("gradTab") ||
         target.id.match("satTab"))
   ) {

      // adjust chart size based on browser window size
      let windowWidth = window.innerWidth/2 - 125;

      let infoIreadContainers = document.querySelectorAll('[id^="info-container-iread"]');
      let infoIlearnContainers = document.querySelectorAll('[id^="info-container-ilearn"]');
      let infoSatContainers = document.querySelectorAll('[id^="info-container-sat"]');
      let infoGradRateContainers = document.querySelectorAll('[id^="info-container-gradrate"]');

      infoIreadContainers.forEach(el => {
         el.style.display = "none"; 
      });
      infoIlearnContainers.forEach(el => {
         el.style.display = "none"; 
      }); 
      infoGradRateContainers.forEach(el => {
         el.style.display = "none"; 
      });
      infoSatContainers.forEach(el => {
         el.style.display = "none"; 
      });

      analysisPages.classList.remove("open");

      if (schoolType == "K12") {
         typeCategories.classList.add("open");
      }
      else {
         typeCategories.classList.remove("open");
      }

      if (
         (schoolType == "K8" && schoolSubtype != "MS") ||
         (schoolType == "K12" && schoolSubtype == "K8") ||
         schoolSubtype == "K8"
      ) {      

         k8Categories.classList.add("open");

         if (k8Selection == "ireadTab") {
            infoIreadContainers.forEach(el => {
               el.style.display = "flex"; 
            });
            ireadInfoTotal.width(windowWidth);
            ireadInfoEthnicity.width(windowWidth);
            ireadInfoSubgroup.width(windowWidth);
         }
         else if (k8Selection == "ilearnTab") {
            infoIlearnContainers.forEach(el => {
               el.style.display = "flex"; 
            });
            elaIlearnInfoGrade.width(windowWidth);
            elaIlearnInfoEthnicity.width(windowWidth);
            elaIlearnInfoSubgroup.width(windowWidth);
            mathIlearnInfoGrade.width(windowWidth);
            mathIlearnInfoEthnicity.width(windowWidth);
            mathIlearnInfoSubgroup.width(windowWidth);            
         }
      }
      else if (
         (schoolType == "K12" && schoolSubtype == "HS") ||
         schoolType == "HS"
      ) {
         k8Categories.classList.remove("open");
         hsCategories.classList.add("open");

         if (hsSelection == "gradTab") {
            infoGradRateContainers.forEach(el => {
               el.style.display = "flex"; 
            });
            gradRateInfoTotal.width(windowWidth);
            gradRateInfoEthnicity.width(windowWidth);
            gradRateInfoSubgroup.width(windowWidth);
         }
         else if (hsSelection == "satTab") {
            infoSatContainers.forEach(el => {
               el.style.display = "flex"; 
            });
            ebrwSatInfoTotal.width(windowWidth);
            ebrwSatInfoEthnicity.width(windowWidth);
            ebrwSatInfoSubgroup.width(windowWidth);
            mathSatInfoTotal.width(windowWidth);
            mathSatInfoEthnicity.width(windowWidth);
            mathSatInfoSubgroup.width(windowWidth);       
         }
      };

      setYearList(allSchoolsObj,"academic");

      if (strYear == "2020") {
         yearValue = "2019";
      }
      else if (intYear > curAcademicYear) {
         yearValue = curAcademicYear.toString();
      }
      else {
         yearValue = strYear;
      }

      yearSelection.value = yearValue;
      yearSelection.setAttribute("value", yearValue);

      selectedValues["year"] = yearValue;

      // TODO: testing this - want to make sure a HS doesn't have type ireadTab or ilearnTab
      if (schoolType == "HS" || schoolSubtype == "HS") {
         selectedValues.page_tab = "infoTab";
      }

      getAcademicInfoData(selectedValues);
    } // end academic info page

    else if (

   // Academic Analysis Tab and subtabs //
      target.id.match("analysisTab") ||
      selectedPage.match("analysisTab") &&
         (target.id.match("ilearnTab") ||
         target.id.match("ireadTab") ||
         target.id.match("k8Tab") ||
         target.id.match("hsTab") ||
         target.id.match("gradTab") ||
         target.id.match("satTab"))
   ) {

      let analysisIreadContainers = document.querySelectorAll('[id^="analysis-container-iread"]');
      let analysisIlearnContainers = document.querySelectorAll('[id^="analysis-container-ilearn"]');
      let analysisSatContainers = document.querySelectorAll('[id^="analysis-container-sat"]');
      let analysisGradRateContainers = document.querySelectorAll('[id^="analysis-container-gradrate"]');

      analysisIreadContainers.forEach(el => {
         el.style.display = "none"; 
      });
      analysisIlearnContainers.forEach(el => {
         el.style.display = "none"; 
      }); 
      analysisGradRateContainers.forEach(el => {
         el.style.display = "none"; 
      });
      analysisSatContainers.forEach(el => {
         el.style.display = "none"; 
      });

      analysisPages.classList.add("open");

      if (schoolType == "K12") {
         typeCategories.classList.add("open");
      }
      else {
         typeCategories.classList.remove("open");
      }

      if (
         (schoolType == "K8" && schoolSubtype != "MS") ||
         (schoolType == "K12" && schoolSubtype == "K8") ||
         schoolSubtype == "K8"
      ) {      
         k8Categories.classList.add("open");

         if (k8Selection == "ireadTab") {
            analysisIreadContainers.forEach(el => {
               el.style.display = "flex"; 
            });

            // analysisIlearnContainers.forEach(el => {
            //    el.style.display = "none"; 
            // });
            // analysisSatContainers.forEach(el => {
            //    el.style.display = "none"; 
            // });
            // analysisGradRateContainers.forEach(el => {
            //    el.style.display = "none"; 
            // });
         }
         else if (k8Selection == "ilearnTab") {
            analysisIlearnContainers.forEach(el => {
               el.style.display = "flex"; 
            });

            // analysisIreadContainers.forEach(el => {
            //    el.style.display = "none"; 
            // });
            // analysisSatContainers.forEach(el => {
            //    el.style.display = "none"; 
            // });
            // analysisGradRateContainers.forEach(el => {
            //    el.style.display = "none"; 
            // });         
         }

       } else if (
         (schoolType == "K12" && schoolSubtype == "HS") ||
         schoolType == "HS"
      ) {
         k8Categories.classList.remove("open");
         hsCategories.classList.add("open");

         if (hsSelection == "gradTab") {
            analysisGradRateContainers.forEach(el => {
               el.style.display = "flex"; 
            });

            // analysisIreadContainers.forEach(el => {
            //    el.style.display = "none"; 
            // });
            // analysisIlearnContainers.forEach(el => {
            //    el.style.display = "none"; 
            // });
            // analysisSatContainers.forEach(el => {
            //    el.style.display = "none"; 
            // });            
         }
         else if (hsSelection == "satTab") {
            analysisSatContainers.forEach(el => {
               el.style.display = "flex"; 
            });

            // analysisIreadContainers.forEach(el => {
            //    el.style.display = "none"; 
            // });
            // analysisIlearnContainers.forEach(el => {
            //    el.style.display = "none"; 
            // }); 
            // analysisGradRateContainers.forEach(el => {
            //    el.style.display = "none"; 
            // });
         }
      };


      setYearList(allSchoolsObj,"academic");

      if (strYear == 2020) {
         yearValue = 2019;
      }
      else if (intYear > curAcademicYear) {
         yearValue = curAcademicYear.toString();;
      }
      else {
         yearValue = strYear;
      }

      yearSelection.value = yearValue;
      yearSelection.setAttribute("value", yearValue);
      
// TODO: Need to figure out how to prevent this from triggering on page change ??

      // if we are here because the school type changed (e.g., K8 to HS),
      // we need to reload the comparison school list with the new data
      // getComparisonSchools automatically repopulates the dropdown
      if (target.id.match("k8Tab")) {
         // selectedValues.school_type = "K8"
         selectedValues.school_subtype = "K8"
         getComparisonSchools(selectedValues);
      } else if (target.id.match("hsTab")) {
         // selectedValues.school_type = "HS"
         selectedValues.school_subtype = "HS"
         getComparisonSchools(selectedValues);
      };

      selectedValues.year = yearValue;
      selectedValues.comparison_schools = getComparisonSchoolIDs()

      getAcademicAnalysisData(selectedValues);

      // adjust chart size based on browser window size
      // let windowWidth = window.innerWidth/2 - 125;
      // ireadComparisonTotal.width(windowWidth);
      // ireadComparisonEthnicity.width(windowWidth);
      // ireadComparisonSubgroup.width(windowWidth);
      // elaILEARNComparisonTotal.width(windowWidth);
      // elaILEARNComparisonGrade.width(windowWidth);
      // elaILEARNComparisonEthnicity.width(windowWidth);
      // elaILEARNComparisonSubgroup.width(windowWidth);
      // mathILEARNComparisonTotal.width(windowWidth);
      // mathILEARNComparisonGrade.width(windowWidth);
      // mathILEARNComparisonEthnicity.width(windowWidth);
      // mathILEARNComparisonSubgroup.width(windowWidth);

   } // end academic analysis

};

/* Main Block */

// Preload all charts on all tabs on first load
if (document.readyState !== "loading") {
   setYearList(allSchoolsObj,"demographic");

   let selectedValues = getSelectedValues();

   const k8Categories = document.querySelector(".k8nav");
   const hsCategories = document.querySelector(".hsnav");
   const typeCategories = document.querySelector(".typenav");
   const analysisPages = document.querySelector(".analysisnav");

   analysisPages.classList.remove("open");
   typeCategories.classList.remove("open");
   hsCategories.classList.remove("open");
   k8Categories.classList.remove("open");
      
   getDemographicData(selectedValues);
   getAcademicInfoData(selectedValues);

   getComparisonSchools(selectedValues);

   // NOTE: on initialization, getComparisonSchoolIDs() returns [] because
   // comparisonSelect isn't yet initialized
   selectedValues.comparison_schools = getComparisonSchoolIDs()

   getAcademicAnalysisData(selectedValues);
}

// initialize page by setting the corp list
setCorpList(allSchoolsObj)

d3.select(window).on("resize", resize);

function resize() {
   // TODO: prob better way to do this- at this point setting size
   // as half the value of the innerwidth of the window
   // TODO: Add breakpoint for single cols
   // TODO: create function for width calls
   // TODO: Add call to fix chart legends

   let selectedValues = getSelectedValues();

   let windowWidth = window.innerWidth/2 - 125;
   
   if (windowWidth >= 290) {

      if (selectedValues.page_tab === "analysisTab") {

         // TODO: This isn't working for some reason //

         // ireadComparisonTotal.width(windowWidth);
         // ireadComparisonEthnicity.width(windowWidth);
         // ireadComparisonSubgroup.width(windowWidth);
         // elaILEARNComparisonTotal.width(windowWidth);
         // elaILEARNComparisonGrade.width(windowWidth);
         // elaILEARNComparisonEthnicity.width(windowWidth);
         // elaILEARNComparisonSubgroup.width(windowWidth);
         // mathILEARNComparisonTotal.width(windowWidth);
         // mathILEARNComparisonGrade.width(windowWidth);
         // mathILEARNComparisonEthnicity.width(windowWidth);
         // mathILEARNComparisonSubgroup.width(windowWidth);

      }
      else if (selectedValues.page_tab === "infoTab") {
         elaIlearnInfoGrade.width(windowWidth);
         elaIlearnInfoEthnicity.width(windowWidth);
         elaIlearnInfoSubgroup.width(windowWidth);
         mathIlearnInfoGrade.width(windowWidth);
         mathIlearnInfoEthnicity.width(windowWidth);
         mathIlearnInfoSubgroup.width(windowWidth);
         gradRateInfoTotal.width(windowWidth);
         gradRateInfoEthnicity.width(windowWidth);
         gradRateInfoSubgroup.width(windowWidth);
         ebrwSatInfoTotal.width(windowWidth);
         ebrwSatInfoEthnicity.width(windowWidth);
         ebrwSatInfoSubgroup.width(windowWidth);
         mathSatInfoTotal.width(windowWidth);
         mathSatInfoEthnicity.width(windowWidth);
         mathSatInfoSubgroup.width(windowWidth);
      }
      else {
         enrollmentChart.width(windowWidth);
         attendanceChart.width(windowWidth);
         ethnicityDemoChart.width(windowWidth);
         statusDemoChart.width(windowWidth);
      }
   }
}
</script>
</html>