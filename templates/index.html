<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
   <title>Indiana School Academic Dashboard</title>
   
   <link  rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
   <!-- <script src="https://d3js.org/d3.v5.js"></script> -->
   <!-- <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script> -->
   <!-- <script src="https://unpkg.com/slim-select@latest/dist/slimselect.min.js"></script> -->
   <!-- <link rel="stylesheet" href="https://unpkg.com/slim-select@latest/dist/slimselect.css" /> -->
   <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-zrnmn8R8KkWl12rAZFt4yKjxplaDaT7/EUkKm7AovijfrQItFWR7O/JJn4DAa/gx" crossorigin="anonymous">
   
   <!-- Imported Modules (Local) -->
   <script src="{{ url_for('static', filename='slimselect.min.js')}}"></script>
   <script src="{{ url_for('static', filename='d3.v5.js')}}"></script>
   <script src="{{ url_for('static', filename='ag-grid-community.min.js')}}"></script>
   
   <!-- Local Modules -->
   <script src="{{ url_for('static', filename='d3-helpers.js')}}"></script>
   <script src="{{ url_for('static', filename='helpers.js')}}"></script>
   <script src="{{ url_for('static', filename='utils.js')}}"></script>
   <script src="{{ url_for('static', filename='d3-utils.js')}}"></script>   
   <link rel="stylesheet" media="all" href="{{ url_for('static', filename='dashboard.css')}}">

   <!-- Imported Stylesheets (Local) -->
   <link rel="stylesheet" media="all" href="{{ url_for('static', filename='slim-select.css')}}">
   <!-- <link rel="stylesheet" media="all" href="{{ url_for('static', filename='all.css')}}"> -->
</head>
<body>
   <h3>Indiana Public School Academic Dashboard</h3>
   <form name="dashboardselect" id="dropdown">
      <label>Select School Corporation:</label>
      <select name="corporation" id="corpSelect"></select>
      <br>
      <label>Select School:</label>
      <select name="school" id="schoolSelect"></select>
      <br>
      <label>Select Year:</label>
      <select name="year" id="yearSelect"></select>
   </form>

   <div id ="allnav">
      <div class="row">
         <div class="nav-container twelve columns">
            <div id="nav-tabs" class="nav">
               <button data-tab="tab-n-1" id="demoTab" class="tab main active">Demographics</button>
               <button data-tab="tab-n-2" id="infoTab" class="tab main">Academic Information</button>
               <button data-tab="tab-n-3" id="analysisTab" class="tab main">Academic Analysis</button>
            </div>
         </div>
      </div>
      <div class="row">
         <div class="nav-container twelve columns">
            <div id="analysisnav-tabs" class="analysisnav">
               <button data-analysistab="tab-a-1" id="singleTab" class="tab analysis active">Selected Year</button>
               <button data-analysistab="tab-a-2" id="multiTab" class="tab analysis">Multi-Year</button>
            </div>
         </div>
      </div>               
      <div class="row">
         <div class="nav-container twelve columns">
            <div id="typenav-tabs" class="typenav">
               <button data-typetab="tab-t-1" id="k8Tab" class="tab type active">K8</button>
               <button data-typetab="tab-t-2" id="hsTab" class="tab type">HS</button>
            </div>
         </div>
      </div>
      <div class="row">
         <div class="nav-container twelve columns">
            <div id="k8nav-tabs" class="k8nav">
               <button data-k8tab="tab-k-1" id="ilearnTab" class="tab k8info active">ILEARN</button>
               <button data-k8tab="tab-k-2" id="ireadTab" class="tab k8info">IREAD</button>
            </div>
         </div>
      </div>
      <div class="row">
         <div class="nav-container twelve columns">
            <div id="hsnav-tabs" class="hsnav">
               <button data-hstab="tab-h-1" id="gradTab" class="tab hsinfo active">Graduation Rate</button>
               <button data-hstab="tab-h-2" id="satTab" class="tab hsinfo">SAT</button>
            </div>
         </div>
      </div>      
   </div>
   <div class="row">
      <div class="panel-container">
         <div id="tab-content">
            <div data-tab="tab-n-1" class="active">
               <section id="tab-one">
                  <div class="grid">
                     <div class="empty-box tab1-a-label" id="demo-container-1-label-1"><div class="label__header"><div id="demo-container-1-label-1-text">Total Enrollment</div></div></div>
                     <div class="table-box tab1-a1-table" id="demo-container-1-table-1"><div id="enrollmentTable" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab1-a2-lines" id="demo-container-1-chart-1"><div id="enrollmentChart"></div></div>

                     <div class="empty-box tab1-b-label" id="demo-container-2-label-2"><div class="label__header" id="demo-container-2-label-1-text">Attendance Rate and Chronic Absenteeism</div></div>
                     <div class="table-box tab1-b1-table" id="demo-container-2-table-2"><div id="attendanceTable" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab1-b2-lines" id="demo-container-2-chart-2"><div id="attendanceChart"></div></div>

                     <div class="group-box tab1-c1-stack" id="demo-container-3-stack-1"><div id="ethnicityDemoChart"></div></div>
                     <div class="group-box tab1-c2-stack" id="demo-container-3-stack-2"><div id="statusDemoChart"></div></div>
                  </div>
               </section>
            </div>
            <div data-tab="tab-n-2">
               <section id="tab-two">
                  <div class="grid">
                     <div class="empty-box tab2-label-1" id="info-container-sm-label-1"><div id="label1" class="label__header"></div></div>
                     <div class="table-box tab2-table-1" id="info-container-sm-table-1"><div id="table1" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-1" id="info-container-sm-chart-1"><div id="chart1"></div></div>

                     <div class="empty-box tab2-label-2" id="info-container-sm-label-2"><div id="label2" class="label__header"></div></div>
                     <div class="table-box tab2-table-2" id="info-container-sm-table-2"><div id="table2" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-2" id="info-container-sm-chart-2"><div id="chart2"></div></div>

                     <div class="empty-box tab2-label-3" id="info-container-sm-label-3"><div id="label3" class="label__header"></div></div>
                     <div class="table-box tab2-table-3" id="info-container-sm-table-3"><div id="table3" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-3" id="info-container-sm-chart-3"><div id="chart3"></div></div>

                     <div class="empty-box tab2-label-4" id="info-container-lg-label-4"><div id="label4" class="label__header"></div></div>
                     <div class="table-box tab2-table-4" id="info-container-lg-table-4"><div id="table4" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-4" id="info-container-lg-chart-4"><div id="chart4"></div></div>
                     <div class="stack-box tab2-stack-4" id="info-container-stack-4"><div id="stack4"></div></div>

                     <div class="empty-box tab2-label-5" id="info-container-lg-label-5"><div id="label5" class="label__header"></div></div>
                     <div class="table-box tab2-table-5" id="info-container-lg-table-5"><div id="table5" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-5" id="info-container-lg-chart-5"><div id="chart5"></div></div>
                     <div class="stack-box tab2-stack-5" id="info-container-stack-5"><div id="stack5"></div></div>

                     <div class="empty-box tab2-label-6" id="info-container-lg-label-6"><div id="label6" class="label__header"></div></div>
                     <div class="table-box tab2-table-6" id="info-container-lg-table-6"><div id="table6" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-6" id="info-container-lg-chart-6"><div id="chart6"></div></div>
                     <div class="stack-box tab2-stack-6" id="info-container-stack-6"><div id="stack6"></div></div>

                     <div class="empty-box tab2-label-7" id="info-container-lg-label-7"><div id="label7" class="label__header"></div></div>
                     <div class="table-box tab2-table-7" id="info-container-lg-table-7"><div id="table7" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-7" id="info-container-lg-chart-7"><div id="chart7"></div></div>
                     <div class="stack-box tab2-stack-7" id="info-container-stack-7"><div id="stack7"></div></div>

                     <div class="empty-box tab2-label-8" id="info-container-lg-label-8"><div id="label8" class="label__header"></div></div>
                     <div class="table-box tab2-table-8" id="info-container-lg-table-8"><div id="table8" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-8" id="info-container-lg-chart-8"><div id="chart8"></div></div>
                     <div class="stack-box tab2-stack-8" id="info-container-stack-8"><div id="stack8"></div></div>

                     <div class="empty-box tab2-label-9" id="info-container-lg-label-9"><div id="label9" class="label__header"></div></div>
                     <div class="table-box tab2-table-9" id="info-container-lg-table-9"><div id="table9" style="width: 100%; height: 100%" class="ag-theme-quartz"></div></div>
                     <div class="box tab2-lines-9" id="info-container-lg-chart-9"><div id="chart9"></div></div>
                     <div class="stack-box tab2-stack-9" id="info-container-stack-9"><div id="stack9"></div></div>                     
                  </div>
               </section>
            </div>
            <div data-tab="tab-n-3">
               <section id="tab-three">
               <div class="row">
                  <div class="nav-container twelve columns">
                     <label id="comparisonLabel">Add or Remove Schools:</label>
                     <select id="comparisonSelect" multiple></select>
                  </div>
               </div>
               <div class="row">
                  <div class="nav-container twelve columns">
                     <div class="grid">
                        <!-- <div class="empty-box tab3-a-label"><div class="label__header">Comparison: ELA Proficiency By Ethnicity</div></div> -->
                        <div class="stack-box tab3-chart-1"><div id="elaComparisonByEthnicity"></div></div>
                        <div class="table-box tab3-table-1" id="analysis-container-table-1"><div id="analysis-table1" style="width: 100%" class="ag-theme-quartz"></div></div>
                        <div class="stack-box tab3-chart-2"><div id="elaComparisonBySubgroup"></div></div>
                        <div class="table-box tab3-table-2" id="analysis-container-table-2"><div id="analysis-table2" style="width: 100%" class="ag-theme-quartz"></div></div>
                        <!-- <div class="stack-box tab3-c-group"><div id="elaComparisonByGrade"></div></div> -->
                     </div>
                  </div>
               </div>
               </section>
            </div>
         </div>
      </div>
   </div>
</body>
<script type="module">

// Indiana Public School Academic Dashboard
// author:   jbetley (https://github.com/jbetley)
// version:  0.9
// date:     01.25.25

// Max Academic and Demographic Years
const getMaxYears = `${window.origin}/config`;
const yearResponse = await fetch(getMaxYears);
const maxYears = await yearResponse.json();

const curAcademicYear = maxYears.academic_year
const curDemographicYear = maxYears.demographic_year

// List of Corporation and School Names for dropdown
const allSchoolsUrl = `${window.origin}/load`;
const allSchoolsResponse = await fetch(allSchoolsUrl);
var allSchoolsObj = await allSchoolsResponse.json();

allSchoolsObj.forEach(function (obj) {
   obj["Corporation Name"] = obj["Corporation Name"] + " (" + toString(obj["Corporation ID"]) + ")"
   obj["School Name"] = obj["School Name"] + " (" + toString(obj["School ID"]) + ")"
});

// chart variables
const subjectIlearn = ["ELA", "Math"];
const subjectGrad = ["Graduation", "Graduation"];
const subjectIread = ["IREAD", "IREAD"]
const subjectSAT = ["EBRW", "Math"]
const grade = ["Grade 3", "Grade 4", "Grade 5", "Grade 6", "Grade 7", "Grade 8", "Total"];
const ethnicity = ["American Indian","Asian","Black","Hispanic","Multiracial","Native Hawaiian or Other Pacific Islander","White"];
const subgroup = ["Special Education","General Education","Paid Meals","Free or Reduced Price Meals","English Language Learners","Non English Language Learners"];
const categoryList = [grade, ethnicity, subgroup];
const allCategories = ethnicity + subgroup + grade;

var enrollmentChart;
var attendanceChart;
var ethnicityDemoChart;
var statusDemoChart;
var enrollmentTableGridApi;
var attendanceTableGridApi;
var infoChart1;
var infoChart2;
var infoChart3;
var infoChart4;
var infoChart5;
var infoChart6;
var infoChart7;
var infoChart8;
var infoChart9;
var infoStack1;
var infoStack2;
var infoStack3;
var infoStack4;
var infoStack5;
var infoStack6;
var infoStack7;
var infoStack8;
var infoStack9;
var infoGridApi = [];
var analysisGridApi = [];
var elaComparisonByEthnicity;
var elaComparisonBySubgroup;

// https://www.pluralsight.com/resources/blog/guides/handling-nested-http-requests-using-the-fetch-api
// https://dev.to/alexmercedcoder/making-multiple-api-calls-in-javascript-kip
// https://www.makeuseof.com/tag/python-javascript-communicate-json/
// https://stackoverflow.com/questions/66978996/is-there-a-better-way-of-creating-tabs-using-vanilla-javascript-than-this

// TODO: switch to search bar? Need to tweak Corp/School Dropdowns
// https://stackoverflow.com/questions/73066547/search-bar-with-dropdown-list
// https://stackoverflow.com/questions/68075281/search-for-item-in-long-dropdown-list-with-input-filter-but-only-allow-user-to
// https://stackoverflow.com/questions/64861548/searchable-drop-down

// https://slimselectjs.com/
// https://github.com/brianvoe/slim-select

/* Navigation */
var comparisonSelect = new SlimSelect({
  select: "#comparisonSelect",
  settings: {
    alwaysOpen: false,
    contentPosition: "absolute",
    placeholderText: "",
    minSelected: 1,
    maxSelected: 8,
    showSearch: true,
    closeOnSelect: true,
    hideSelected: true
  }
});

/* Event Listeners */

// Selection: School
const schoolSelection = document.getElementById("schoolSelect");

schoolSelection.addEventListener("change", function () {
   let selectedValues = getSelectedValues();

   const mainSelection = document.querySelector(".tab.main.active").id;
   const k8Content = document.querySelector(".k8nav");
   const hsContent = document.querySelector(".hsnav");
   const typeContent = document.querySelector(".typenav");
   const analysisContent = document.querySelector(".typenav");

   // show k8/hs selector for k12 schools on all pages but demographics
   if (mainSelection != "demoTab" && selectedValues.school_type == "K12")
   {
      typeContent.classList.add("open");
      k8Content.classList.remove("open");
      hsContent.classList.remove("open");
   }
   else {
      typeContent.classList.remove("open");
   }

   let k8TypeTab = document.getElementById("k8Tab");
   let hsTypeTab = document.getElementById("hsTab");

   if (mainSelection == "infoTab" || mainSelection == "analysisTab") {
      if (selectedValues.school_type == "K8" ||
         (selectedValues.school_subtype == "K8" && selectedValues.school_subtype != "MS"))
      {
         k8Content.classList.add("open");
         hsContent.classList.remove("open");
         k8TypeTab.classList.add("active");
         hsTypeTab.classList.remove("active");
         selectedValues.type_tab = "k8Tab"

      }
      else if (selectedValues.school_type == "HS" ||
         (selectedValues.school_type == "K12" && selectedValues.school_subtype == "HS"))
      {
         k8Content.classList.remove("open");
         hsContent.classList.add("open");
         k8TypeTab.classList.remove("active");
         hsTypeTab.classList.add("active");
         selectedValues.type_tab = "hsTab"
      } 
   }

   if (mainSelection === "analysisTab") {

      analysisContent.classList.add("open");

      // this populates the selecetedValues dict with a list of comparison
      // school ids
      getComparisonSchools(selectedValues);

      selectedValues.comparison_schools = getComparisonSchoolIDs();
      // let comparisonValues = getComparisonSchoolIDs();
      console.log("SCHOOL SELECTION")
      // console.log(comparisonValues)
      console.log(selectedValues)
      getAcademicAnalysisData(selectedValues);

   }
   else if (mainSelection === "infoTab")  {
      analysisContent.classList.remove("open");
      getAcademicInfoData(selectedValues);
   }
   else {
      analysisContent.classList.remove("open");
      getDemographicData(selectedValues)
   }

});

function getSchoolSelection() {
   let schoolIDValue;

   if (schoolSelection != null && schoolSelection.value == "") {
      schoolIDValue = allSchoolsObj.find(e => typeof e !== "undefined")["School ID"]
   }
   else {
      schoolIDValue = schoolSelection.value
   }

   return schoolIDValue
};


// Selection: Year
let yearSelection = document.getElementById("yearSelect");

yearSelection.addEventListener("change", function () {
   let selectedValues = getSelectedValues();

   if (selectedValues.page_tab === "Academic Analysis") {

      selectedValues.comparison_schools = getComparisonSchoolIDs();
      // let comparisonValues = getComparisonSchoolIDs()

      getAcademicAnalysisData(selectedValues);
   }
   else if (selectedValues.page_tab === "Academic Information")  {
      getAcademicInfoData(selectedValues);
   }
   else {
      getDemographicData(selectedValues)
   }
});

function getSelectedYear() {

   let yearSelectionValue = yearSelection.value;
   
   return yearSelectionValue;
};


// Selection: Comparison Schools
const comparisonSelection = document.getElementById("comparisonSelect");
comparisonSelection.addEventListener("change", function () {
   let selectedValues = getSelectedValues();

   if (selectedValues.page_tab === "Academic Analysis") {

      selectedValues.comparison_schools = getComparisonSchoolIDs();

      // let comparisonValues = getComparisonSchoolIDs();
      getAcademicAnalysisData(selectedValues);
   }
   });

function getComparisonSchoolIDs() {

   let selectedValues = getSelectedValues();
   let comparisonSchools = comparisonSelect.getSelected();
   // selectedValues.comparison_schools = comparisonSchools;
   return comparisonSchools
}

// Selection: Corporation
const corpSelection = document.getElementById("corpSelect");
corpSelection.addEventListener("change", function () {
   setSchoolList(allSchoolsObj)
});

function getCorpSelection() {
   let corpIDValue;

   if (corpSelection != null && corpSelection.value == "") {
      // finds first element in array even if it falsy (but not if undefined)
      corpIDValue = allSchoolsObj.find(e => typeof e !== "undefined")["Corporation ID"]
   }
   else {
      corpIDValue = corpSelection.value
   }

   return corpIDValue
}

// get all active values
function getSelectedValues() {

   const year = getSelectedYear();
   const schoolId = getSchoolSelection();
   const corpId = getCorpSelection();
   const pageTab = document.querySelector(".tab.main.active").id;
   const typeTab = document.querySelector(".tab.type.active").id;
   const k8Tab = document.querySelector(".tab.k8info.active").id;
   const hsTab = document.querySelector(".tab.hsinfo.active").id;
   const analysisTab = document.querySelector(".tab.analysis.active").id;

   let schoolInfo = allSchoolsObj.filter(o => o["School ID"] == schoolId && o.Year == year);

   let school_type = schoolInfo[0]["School Type"]
   let school_subtype = schoolInfo[0]["Sub Type"]

   if (pageTab != "demoTab" && school_type == "K12") {
      if (typeTab == "hsTab") {
         school_subtype = "HS"
      }
      else {
         school_subtype = "K8"
      }
   }

   // using snake case here because we will be passing this dict\
   // to python scripts
   let selectedValues = {};
   selectedValues.school_id = schoolId;
   selectedValues.year = year;
   selectedValues.school_type = school_type;
   selectedValues.school_subtype = school_subtype;
   selectedValues.comparison_schools = [];
   selectedValues.page_tab = pageTab;
   selectedValues.k8_tab = k8Tab;
   selectedValues.hs_tab = hsTab;
   selectedValues.type_tab = typeTab;
   selectedValues.analysis_tab = analysisTab; 

   return selectedValues
}

function setSelectedValue(key, value) {
   selectedValues[key] = value;
   console.log("setSelected")
   console.log(selectedValues)
}

// var activeMainTab = document.querySelectorAll(".tab.active")[0].innerHTML;
// var activeSubInfoTab = document.querySelectorAll(".tab.info.active")[0].innerHTML;
// var activeTypeTab = document.querySelectorAll(".tab.type.active")[0].innerHTML;

// Navigation
// https://stackoverflow.com/questions/66978996/is-there-a-better-way-of-creating-tabs-using-vanilla-javascript-than-this
// https://stackoverflow.com/questions/50774938/vanilla-javascript-toggle-drop-down-menu

// switches active status and hides or shows subnavigation
const navTabs = document.querySelector("div#nav-tabs"),
   nav_tab_elms = document.querySelectorAll("button[data-tab], div[data-tab]"),
   k8navTabs = document.querySelector("div#k8nav-tabs"),
   k8nav_tab_elms = document.querySelectorAll("button[data-k8tab]"),
   hsnavTabs = document.querySelector("div#hsnav-tabs"),
   hsnav_tab_elms = document.querySelectorAll("button[data-hstab]"),
   typenavTabs = document.querySelector("div#typenav-tabs"),
   typenav_tab_elms = document.querySelectorAll("button[data-typetab]"),
   analysisnavTabs = document.querySelector("div#analysisnav-tabs"),
   analysisnav_tab_elms = document.querySelectorAll("button[data-analysistab]");

navTabs.onclick = ({target}) => {

   const schoolType = getSelectedValues().school_type;
   const schoolSubtype = getSelectedValues().school_subtype;

   // ignore other clicks in this area (like spaces between buttons)
   if (!target.matches("button[data-tab]")) return

   // cycling through "dataset", tab-n-1", "tab-n-2", etc. and setting
   // class to active where the target.dataset equals the class
   nav_tab_elms.forEach(elTab => {
      elTab.classList
      .toggle("active", (elTab.dataset.tab===target.dataset.tab))
   })
};

// ILEARN/IREAD
k8navTabs.onclick = ({target}) => {

   if (!target.matches("button[data-k8tab]")) return

   k8nav_tab_elms.forEach(elTab => {
      elTab.classList
      .toggle("active", (elTab.dataset.k8tab===target.dataset.k8tab))
   })
};

// Graduation Rate/SAT
hsnavTabs.onclick = ({target}) => {

   if (!target.matches("button[data-hstab]")) return

   hsnav_tab_elms.forEach(elTab => {
      elTab.classList
      .toggle("active", (elTab.dataset.hstab===target.dataset.hstab))
   })
};

// School type
typenavTabs.onclick = ({target}) => {

   if (!target.matches("button[data-typetab]")) return

   typenav_tab_elms.forEach(elTab => {
      elTab.classList
      .toggle("active", (elTab.dataset.typetab===target.dataset.typetab))
   })
};

// Analysis Year
analysisnavTabs.onclick = ({target}) => {

if (!target.matches("button[data-analysistab]")) return

analysisnav_tab_elms.forEach(elTab => {
   elTab.classList
   .toggle("active", (elTab.dataset.analysistab===target.dataset.analysistab))
})
};


/* App Initialization */

function setYearList(data, id) {

   let selectedYear = yearSelection;

   removeOptions(selectedYear);

   let yearValue,
      maxYear;

   let availableYears = [... new Set(data.map(o => o.Year))];

   if (id == "demographic") {
      maxYear = curDemographicYear;
   }
   else {
      maxYear = curAcademicYear;
   };

   // make sure selected Year is not greater than max academic year
   availableYears = availableYears.filter(arr => arr <= maxYear);
   availableYears.sort((a, b) => (a > b ? -1 : 1))

   if (id == "academic") {
      // TODO: temporarily removing "2020" because there is no
      // academic data for k8 - eventually need to add it back for HS
      const index = availableYears.indexOf(2020);
      if (index > -1) {
         availableYears.splice(index, 1);
      }
   }
   availableYears.forEach((year) => selectedYear.appendChild(new Option(year, year)));
};


function setCorpList (data) {
   const year = getSelectedYear();

   let yearData = data.filter(o => o.Year == Number(year));

   // remove duplicates
   let corpDropdown = yearData.filter(
      (v,i,a)=>a.findIndex(v2=>(v2["Corporation ID"]===v["Corporation ID"]))===i
   );

   corpDropdown.forEach(
      (corp) => corpSelection
      .appendChild(new Option(corp["Corporation Name"], corp["Corporation ID"]))
   );

   // initialize school list
   setSchoolList(data);
}


function setSchoolList(data) {
   let schoolDropdown = []
   let selectedValues = getSelectedValues();
   
   const pageTab = selectedValues.page_tab;
   const year = getSelectedYear();
   const corpID = getCorpSelection();

   let yearData = data.filter(o => o.Year == Number(year));

   schoolDropdown = yearData.filter(obj => obj["Corporation ID"] == corpID)

   // clears school dropdown element before rebuilding
   removeOptions(schoolSelection);

   schoolDropdown.forEach(
      (school) => schoolSelection
      .appendChild(new Option(school["School Name"], school["School ID"]))
   );

   // load comparison schools
   if (pageTab === "analysisTab") {
      getComparisonSchools(selectedValues);
   };

   // TODO: Should this be outside of the function??
   // auto trigger change event whenever School List changes
   var event = new Event("change");
   schoolSelection.dispatchEvent(event);
};

/// Comparison List - Run each time academic analysis tab is selected ///
function setComparisonList(data) {
   
   let subset = data.map(({ ["School ID"]: value, ["School Name"]: text }) => ({ text, value }));
   
   // remove selected school from dropdown
   subset = subset.slice(1);

   // set list of available comparison schools
   comparisonSelect.setData([]);
   comparisonSelect.setData(subset);

   // as default, select first 4 (closest) schools
   let initialSelections = subset.map(function (obj) {
      return obj.value;
   });

   initialSelections = initialSelections.slice(0, 4);
   comparisonSelect.setSelected(initialSelections);
};


/* Flask calls */

// demographic data
async function getDemographicData(select) {
   const fetchedData = await fetch(`${window.origin}/demographic`, {
      method: "POST",
         credentials: "include",
         cache: "no-cache",
         headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
      },
      body:JSON.stringify(select)})
      .then(response=>{
         if (response.ok) {
            return response.json()
         } else {
            alert("Network Error: Could not load data.")
         }
      });

   let demData = fetchedData[0];
   demographicsPage(demData, select);
}

// academic information data
async function getAcademicInfoData(select) {
   const fetchedData = await fetch(`${window.origin}/academic`, {
      method: "POST",
         credentials: "include",
         cache: "no-cache",
         headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
      },
      body:JSON.stringify(select)})
      .then(response=>{
         if (response.ok) {
            return response.json()
         } else {
            alert("Network Error: Could not load data.")
         }
      })

      let infoData = fetchedData[0];
      academicInfoPage(infoData);
}

// academic analysis Data
async function getAcademicAnalysisData(select) {

   const fetchedData = await fetch(`${window.origin}/academic`, {
      method: "POST",
      headers: {
            "Content-type": "application/json",
            "Accept": "application/json"
      },
      body:JSON.stringify(select)
   })
   .then(response=>{
      if (response.ok) {
         return response.json()
      } else {
         alert("Network Error: Could not load data.")
      }
   });

   let analysisData = fetchedData[0]
   academicAnalysisPage(analysisData)
};

// comparison dropdown
async function getComparisonSchools(select) {
   const comparisonSchoolList = await fetch(`${window.origin}/where`, {
      method: "POST",
      headers: {
            "Content-type": "application/json",
            "Accept": "application/json"
      },
      body:JSON.stringify(select)})
      .then(response=>{
         if (response.ok) {
            return response.json()
         } else {
            alert("Network Error: Could not load data.")
         }
      })

      setComparisonList(comparisonSchoolList)
}

/* Pages */

// Demographic Data
function demographicsPage(data, select) {
   const schoolId = select.school_id;
   const year = select.year;
   
   let schoolData = data.filter((ele) => ele["School ID"] === Number(schoolId));
   let corpData = data.filter((ele) => ele["School ID"] != Number(schoolId));

   // number of years to limit data - each element in the array
   // represents one year in descending order- so we want to
   // remove elements from the front of the array to get array
   // size to yearLimit
   const yearLimit = 5;

   const yearsToRemove = schoolData.length - yearLimit;
   
   if (yearsToRemove > 0 ) {
      schoolData = dropElements(schoolData, yearsToRemove);
      corpData = dropElements(corpData, yearsToRemove);
   };

   const curYearSchoolDemographics = schoolData.filter((ele) => ele.Year === Number(year))[0];
   const curYearCorpDemographics = corpData.filter((ele) => ele.Year === Number(year))[0];

   // enrollment table data //
   var enrollmentTableObj = Object.entries(curYearSchoolDemographics).reduce((acc, [key, value]) => {
      if (
         (key.startsWith("Grade") && value === 0) ||
         (
            (!key.startsWith("Grade")) && (!key.startsWith("Total"))
         )) {
         return { ...acc };
      }
      return { ...acc, [key]: value };
   }, {});

   // this is the weird as shit way that you rename stuff in js
   delete Object.assign(enrollmentTableObj,
      {["Total"]: enrollmentTableObj["Total Enrollment"]})["Total Enrollment"];

   removeItemsByValue(enrollmentTableObj,"0")

   var enrollmentTableData = Object.keys(enrollmentTableObj)
      .map(key => ({grade: key, enrollment: enrollmentTableObj[key]}));

   // numerically sort the list of grades using only the number part of the string (Grade 5)
   enrollmentTableData.sort((a,b) => parseInt(a.grade.slice(6)) - parseInt(b.grade.slice(6)));

   // enrollment chart
   let keep = ["Year","Total Enrollment"];

   var enrollmentChartData = filterObj(schoolData, keep);

   // attendance and chronic absenteeism
   keep = ["Year","Attendance Rate", "Chronic Absenteeism %"];
   var attendanceChartData = filterObj(schoolData, keep);

   let attChartkeys = getKeys(attendanceChartData);
   const attChartcols = attChartkeys.filter(e => e !== "Year");
   attendanceChartData["columns"] = attChartcols;

   let attendanceTableData = transposeData(attendanceChartData, "Year");

   // demographic chart data //
   const ethnicityCategories = ethnicity.concat(["School Name", "Total Enrollment"]);
   const statusCategories = subgroup.concat(["School Name", "Total Enrollment"]);

   let ethnicityYearSchool = filterCategories(curYearSchoolDemographics, ethnicityCategories);
   let ethnicityYearCorp = filterCategories(curYearCorpDemographics, ethnicityCategories);
   let statusYearSchool = filterCategories(curYearSchoolDemographics, statusCategories);
   let statusYearCorp = filterCategories(curYearCorpDemographics, statusCategories);

   // inputs: entity data; array of categories; the value we are finding percentage of,
   // and min percentage to include in final data
   findPercentage(ethnicityYearSchool, ethnicity, ethnicityYearSchool["Total Enrollment"], .005);
   findPercentage(ethnicityYearCorp, ethnicity, ethnicityYearCorp["Total Enrollment"], 0);
   findPercentage(statusYearSchool, subgroup, statusYearSchool["Total Enrollment"], .005);
   findPercentage(statusYearCorp, subgroup, statusYearCorp["Total Enrollment"], 0);

   // create a string with missing categories if such categories exist
   // and then remove missing data keys
   var missingEthnicityString = findMissing(ethnicityYearSchool, ethnicityYearCorp);
   var missingStatusString = findMissing(statusYearSchool, statusYearCorp);

   // merge school and corp objects
   let ethnicityArray = [ethnicityYearSchool];
   ethnicityArray.push(ethnicityYearCorp);

   let ethnicityTransposed = transposeData(ethnicityArray, "School Name");
   var ethnicityDemoChartData = processBarData(ethnicityTransposed);

   let statusArray = [statusYearSchool];
   statusArray.push(statusYearCorp);

   let statusTransposed = transposeData(statusArray, "School Name");
   var statusDemoChartData = processBarData(statusTransposed);

   // initialize page
   if (!demographicsPage.initialize) {

      // Enrollment Table
      let enrollmentTableOptions = createEnrollmentTable(enrollmentTableData);
      const enrollmentTableGridDiv = document.querySelector("#enrollmentTable");
      enrollmentTableGridApi = agGrid.createGrid(enrollmentTableGridDiv, enrollmentTableOptions);

      // Enrollment Chart
      enrollmentChart = singleLine().data(enrollmentChartData).id("enrollmentChart");
      d3.select("#enrollmentChart").call(enrollmentChart);

      // Chronic Absenteeism and Attendance Rate Table
      let attendanceTableOptions = createBasicTable(attendanceTableData);
      const attendanceTableGridDiv = document.querySelector("#attendanceTable");
      attendanceTableGridApi = agGrid.createGrid(attendanceTableGridDiv, attendanceTableOptions);

      // Chronic Absenteeism and Attendance Rate Chart
      attendanceChart = multiLine().data(attendanceChartData).id("attendanceChart");
      d3.select("#attendanceChart").call(attendanceChart);

      // Demographics Bar Chart - Ethnicity
      ethnicityDemoChart = horizontalGroupBar().data([ethnicityDemoChartData,missingEthnicityString]).id("ethnicityDemoChart");
      d3.select("#ethnicityDemoChart").call(ethnicityDemoChart);

      // Demographics Bar Chart - Subgroup
      statusDemoChart = horizontalGroupBar().data([statusDemoChartData,missingStatusString]).id("statusDemoChart");
      d3.select("#statusDemoChart").call(statusDemoChart);

      demographicsPage.initialize = true;
   }
   else {   // update page
      let enrollmentTableOptions = createEnrollmentTable(enrollmentTableData);
      enrollmentTableGridApi.setGridOption("columnDefs", enrollmentTableOptions.columnDefs);
      enrollmentTableGridApi.setGridOption("rowData", enrollmentTableData);
      enrollmentChart.data(enrollmentChartData).id("enrollmentChart");

      let attendanceTableOptions = createBasicTable(attendanceTableData);
      attendanceTableGridApi.setGridOption("columnDefs", attendanceTableOptions.columnDefs);
      attendanceTableGridApi.setGridOption("rowData", attendanceTableData);
      attendanceChart.data(attendanceChartData).id("attendanceChart");

      ethnicityDemoChart.data([ethnicityDemoChartData,missingEthnicityString]).id("ethnicityDemoChart");
      statusDemoChart.data([statusDemoChartData,missingStatusString]).id("statusDemoChart");
   };
};

// Academic Information
function academicInfoPage(data) {

   let selection = getSelectedValues();

   // TODO: HANDLE BLANK TABLE
   if (!Array.isArray(data) || !data.length) {
      console.log("NO DATA")
      console.log(data)
      // TODO: BLANK TABLE
   }

   // TODO: Test whether there is any difference between the values that are passed into the
   // data gathering functions and getSelectedValues(). Want to avoid issue where they don't
   // align.

   // this should occur only when the first school in list is a K12 school on load (currently
   // it is)
   if (selection.school_type == "K12" && selection.school_subtype == "K12") {
      selection.school_subtype = "K8"
   }

   const year = selection.year;
   const schoolType = selection.school_type
   const schoolSubtype = selection.school_subtype
   const pageTab = selection.page_tab
   const typeTab = selection.type_tab
   const k8Tab = selection.k8_tab
   const hsTab = selection.hs_tab

   let subject;
   let labelsSm = document.querySelectorAll('[id^="info-container-sm-label"]');
   let labelsLg = document.querySelectorAll('[id^="info-container-lg-label"]');

   // Subject: "ELA" & "Math"
   let ilearnLabelSuffixes = ["by Grade", "by Ethnicity", "by Subgroup"]

   // Subject: "IREAD"
   const IREADLabelSuffixes = ["Total", "by Ethnicity", "by Subgroup"]

   // Subject: "Graduation Rate" & "SAT"
   let hsLabelSuffixes = ["Overview", "by Ethnicity", "by Subgroup"]

   // set subject, type, and chart labels
   if (schoolType == "K8" || (schoolType == "K12" && schoolSubtype == "K8")) {
      if (k8Tab == "ireadTab") {  

         subject =  subjectIread

         labelsSm.forEach((el, i) => {
            let ireadLabel = subject[0] + " " + IREADLabelSuffixes[i];
            el.firstChild.textContent = ireadLabel;

         });
      }
      else {

         subject = subjectIlearn
         let sub;

         // replicate and interleave (e.g., byGrade,byGrade,byEthnicity . . .)
         const replicated = ilearnLabelSuffixes.flatMap(item => [item, item]); 

         // need to alternate subjects
         labelsLg.forEach((el, i) => {
            if (i % 2 == 0) {
               // sub = "ELA"
               sub = 0;
            }
            else {
               // sub = "Math"
               sub = 1;
            }

            let ilearnLabel = subject[sub] + " " + replicated[i];
            // let ilearnLabel = sub + " " + replicated[i];
            el.firstChild.textContent = ilearnLabel;
         });
      }
   }
   else if (
      schoolType == "HS" || schoolType == "AHS" || 
      (schoolType == "K12" && schoolSubtype == "HS")
   ) {

      let sub;

      if (hsTab == "gradTab") {   

         subject = subjectGrad

         labelsSm.forEach((el, i) => {
            let gradLabel = subject[0] + " " + hsLabelSuffixes[i];
            el.firstChild.textContent = gradLabel;
         });
      }
      else {
         
         subject = subjectSAT;
         let sub;

         const replicated = hsLabelSuffixes.flatMap(item => [item, item]);

         labelsLg.forEach((el, i) => {
            
            if (i % 2 == 0) {
               sub = 0;
               // sub = "EBRW"
            }
            else {
               sub = 1;
               // sub = "Math"
            }

            let satLabel = "SAT" + " " + subject[sub] + " " + replicated[i];
            // let satLabel = "SAT" + " " + sub + " " + replicated[i];
            el.firstChild.textContent = satLabel;
         });
      }
   };
      
   if (!academicInfoPage.initialize) {
      // categories: 1) grade/total; 2) ethnicity; 3) subgroup
      // subjects: 1-3) none; 4-9) ELA/EBRW & Math
      // if iread/grad: tables 1-3
      // if ilearn/sat: tables 4-9
      // proficiency breakdowns display current year only

      let id, name;

      // chart1: IREAD Total / Graduation Rate Total
      infoChart1 = multiLine()
         .data(getK8LineData(data, grade, subject[0], selection))
         .id("chart1");
      d3.select("#chart1")
         .call(infoChart1);

      // chart2: IREAD By Ethnicity / Graduation Rate By Ethnicity
      infoChart2 = multiLine()
         .data(getK8LineData(data, ethnicity, subject[0], selection))
         .id("chart2");
      d3.select("#chart2")
         .call(infoChart2);

      // chart3: IREAD By Subgroup / Graduation Rate By Subgroup
      infoChart3 = multiLine()
         .data(getK8LineData(data, subgroup, subject[0], selection))
         .id("chart3");
      d3.select("#chart3")
         .call(infoChart3);

      // chart4: ILEARN ELA By Grade / SAT EBRW Overview
      infoChart4 = multiLine()
         .data(getK8LineData(data, grade, subject[0], selection))
         .id("chart4");
      d3.select("#chart4")
         .call(infoChart4);

      // stack4
      infoStack4 = horizontalStackedBar()
         .data(getProficiencyBreakdown(data, grade, subject[0], selection))
         .id("stack4");
      d3.select("#stack4")
         .call(infoStack4);

      // chart5: ILEARN Math By Grade / SAT Math Overview
      infoChart5 = multiLine()
         .data(getK8LineData(data, grade, subject[1], selection))
         .id("chart5");
      d3.select("#chart5")
         .call(infoChart5);

      // stack5
      infoStack5 = horizontalStackedBar()
         .data(getProficiencyBreakdown(data, grade, subject[1], selection))
         .id("stack5");
      d3.select("#stack5")
         .call(infoStack5);

      // chart6: ILEARN ELA By Ethnicity / SAT EBRW By Ethnicity          
      infoChart6 = multiLine()
         .data(getK8LineData(data, ethnicity, subject[0], selection))
         .id("chart6");
      d3.select("#chart6")
         .call(infoChart6);

      // stack6
      infoStack6 = horizontalStackedBar()
         .data(getProficiencyBreakdown(data, ethnicity, subject[0], selection))
         .id("stack6");
      d3.select("#stack6")
         .call(infoStack6);

      // chart7: ILEARN Math By Ethnicity / SAT Math By Ethnicity          
      infoChart7 = multiLine()
         .data(getK8LineData(data, ethnicity, subject[1], selection))
         .id("chart7");
      d3.select("#chart7")
         .call(infoChart7);

      // stack7
      infoStack7 = horizontalStackedBar()
         .data(getProficiencyBreakdown(data, ethnicity, subject[1], selection))
         .id("stack7");
      d3.select("#stack7")
         .call(infoStack7);

      // chart8: ILEARN ELA By Subgroup / SAT EBRW By Subgroup         
      infoChart8 = multiLine()
         .data(getK8LineData(data, subgroup, subject[0], selection))
         .id("chart8");
      d3.select("#chart8")
         .call(infoChart8);

      // stack8
      infoStack8 = horizontalStackedBar()
         .data(getProficiencyBreakdown(data, subgroup, subject[0], selection))
         .id("stack8");
      d3.select("#stack8")
         .call(infoStack8);

      // chart9: ILEARN Math By Subgroup / SAT Math By Subgroup         
      infoChart9 = multiLine()
         .data(getK8LineData(data, subgroup, subject[1], selection))
         .id("chart9");
      d3.select("#chart9")
         .call(infoChart9);

      // stack9
      infoStack9 = horizontalStackedBar()
         .data(getProficiencyBreakdown(data, subgroup, subject[1], selection))
         .id("stack9");
      d3.select("#stack9")
         .call(infoStack9);

// Tables
// https://www.ag-grid.com/javascript-data-grid/grid-api/
// https://javascript.plainenglish.io/angular-how-can-you-clear-the-references-of-multiple-ag-grid-tables-together-353610b0c126
// https://stackoverflow.com/questions/67917738/multiple-ag-grids-setselected-to-true-is-only-working-for-the-last-grid
// https://stackoverflow.com/questions/53920531/can-we-change-the-view-for-ag-grid-in-mobile-devices

      // Initialize all nine tables on-load (empty)
      for (let k = 0; k < 9; k++) {
         let tableName = "table" + (k+1);
         let tableID = "#" + tableName

         let tableOptions = initializeTable(tableID)
         var gridDiv = document.querySelector(tableID)
         infoGridApi[k] = agGrid.createGrid(gridDiv, tableOptions);
      }

      academicInfoPage.initialize = true;

   }
   else {      
      
      /* Update */

      let tableNum,
         tableShift; // number of tables to "skip" in the array of nine tables we created on init
      
      if (typeTab == "k8Tab") {

         if (k8Tab == "ilearnTab") {
            tableNum = 6;
            tableShift = 3;
            subject = subjectIlearn

            infoChart4.data(getK8LineData(data, grade, subject[0], selection)).id("chart4")
            infoChart5.data(getK8LineData(data, grade, subject[1], selection)).id("chart5")
            infoChart6.data(getK8LineData(data, ethnicity, subject[0], selection)).id("chart6")
            infoChart7.data(getK8LineData(data, ethnicity, subject[1], selection)).id("chart7")
            infoChart8.data(getK8LineData(data, subgroup, subject[0], selection)).id("chart8")
            infoChart9.data(getK8LineData(data, subgroup, subject[1], selection)).id("chart9")

            infoStack4.data(getProficiencyBreakdown(data, grade, subject[0], selection)).id("stack4")
            infoStack5.data(getProficiencyBreakdown(data, grade, subject[1], selection)).id("stack5")
            infoStack6.data(getProficiencyBreakdown(data, ethnicity, subject[0], selection)).id("stack6")
            infoStack7.data(getProficiencyBreakdown(data, ethnicity, subject[1], selection)).id("stack7")
            infoStack8.data(getProficiencyBreakdown(data, subgroup, subject[0], selection)).id("stack8")
            infoStack9.data(getProficiencyBreakdown(data, subgroup, subject[1], selection)).id("stack9")               
         }

         else if (k8Tab == "ireadTab") {
            tableNum = 3;
            tableShift = 0;
            subject = subjectIread;
            
            const total = ["Total"];

            infoChart1.data(getK8LineData(data, total, subject[0], selection)).id("chart1")
            infoChart2.data(getK8LineData(data, ethnicity, subject[0], selection)).id("chart2")
            infoChart3.data(getK8LineData(data, subgroup, subject[0], selection)).id("chart3")
         }
      }
      else if (typeTab == "hsTab") {
         
         const total = ["Total"];

         if (hsTab == "gradTab") {
            tableNum = 3;
            tableShift = 0;
            subject = subjectGrad;

            infoChart1.data(getK8LineData(data, total, subject[0], selection)).id("chart1")
            infoChart2.data(getK8LineData(data, ethnicity, subject[0], selection)).id("chart2")
            infoChart3.data(getK8LineData(data, subgroup, subject[0], selection)).id("chart3")
         }
         else if (typeTab == "satTab") {
            tableNum = 6;
            tableShift = 3;
            subject = subjectSAT;

            infoChart4.data(getK8LineData(data, total, subject[0], selection)).id("chart4")
            infoChart5.data(getK8LineData(data, total, subject[1], selection)).id("chart5")
            infoChart6.data(getK8LineData(data, ethnicity, subject[0], selection)).id("chart6")
            infoChart7.data(getK8LineData(data, ethnicity, subject[1], selection)).id("chart7")
            infoChart8.data(getK8LineData(data, subgroup, subject[0], selection)).id("chart8")
            infoChart9.data(getK8LineData(data, subgroup, subject[1], selection)).id("chart9")
         }
      };

      /* Update Tables */
      //https://www.ag-grid.com/javascript-data-grid/data-update-row-data/
      // TODO: This seems Kludgy as hell. Loops through array of grids (using a
      // global variable gridAPI) and using the gridDivID to determine which data to use.
      let tableData, tableID, catList;

      // Remove objects with years > the selected year
      const tabledata = data.filter((obj, index) => !(obj.Year > Number(year)));

      for (let i=0; i<tableNum; i++) {

         let index = i + tableShift;
         const sub = i % 2;

         if (tableShift == 0) {
            catList = [grade, ethnicity, subgroup]
         }
         else {
            catList = [grade, grade, ethnicity, ethnicity, subgroup, subgroup]
         }

         tableID = infoGridApi[index].getGridId()


         tableData = getTableData(tabledata, catList[i], subject[sub], selection)

         let tableOptions = createBasicTable(tableData)

         // need to reset columndefs as well as rowdata or else table
         // will have empty cols.
         infoGridApi[index].setGridOption("columnDefs", tableOptions.columnDefs);
         infoGridApi[index].setGridOption("rowData", tableData);
      };
   }
};

// Chart Academic Information
function academicAnalysisPage(data) {

   let selection = getSelectedValues();

   const year = selection.year;
   const schoolType = selection.school_type
   const schoolSubtype = selection.school_subtype
   const schoolID = selection.school_id
   const pageTab = selection.page_tab
   const typeTab = selection.type_tab
   const k8Tab = selection.k8_tab
   const hsTab = selection.hs_tab

   let subject;
   console.log("ACADEMIC ANALYSIS Comparison Year Data")
   
   // set subject, type, and chart labels
   if (
      schoolType == "K8" ||
      (schoolType == "K12" && (schoolSubtype == "K8" || schoolSubtype == "K12")) ||
      (typeof schoolType === "undefined" && typeof schoolSubtype === "undefined")
  ) {

      if (k8Tab == "ireadTab") {  

         subject =  subjectIread

         // labelsSm.forEach((el, i) => {
         //    let ireadLabel = subject[0] + " " + IREADLabelSuffixes[i];
         //    el.firstChild.textContent = ireadLabel;

         // });
      }
      else {

         subject = subjectIlearn
         // let sub;

         // // replicate and interleave (e.g., byGrade,byGrade,byEthnicity . . .)
         // const replicated = ilearnLabelSuffixes.flatMap(item => [item, item]); 

         // // need to alternate subjects
         // labelsLg.forEach((el, i) => {
         //    if (i % 2 == 0) {
         //       // sub = "ELA"
         //       sub = 0;
         //    }
         //    else {
         //       // sub = "Math"
         //       sub = 1;
         //    }

         //    let ilearnLabel = subject[sub] + " " + replicated[i];
         //    // let ilearnLabel = sub + " " + replicated[i];
         //    el.firstChild.textContent = ilearnLabel;
         // });
      }
   }
   else if (
      schoolType == "HS" || schoolType == "AHS" || 
      (schoolType == "K12" && schoolSubtype == "HS")
   ) {

      // let sub;
      if (hsTab == "gradTab") {   

         subject = subjectGrad

         // labelsSm.forEach((el, i) => {
         //    let gradLabel = subject[0] + " " + hsLabelSuffixes[i];
         //    el.firstChild.textContent = gradLabel;
         // });
      }
      else {
         
         subject = subjectSAT;
         // let sub;

         // const replicated = hsLabelSuffixes.flatMap(item => [item, item]);

         // labelsLg.forEach((el, i) => {
            
         //    if (i % 2 == 0) {
         //       sub = 0;
         //    }
         //    else {
         //       sub = 1;
         //    }

         //    let satLabel = "SAT" + " " + subject[sub] + " " + replicated[i];
         //    el.firstChild.textContent = satLabel;
         // });
      }
   };

   // if (schoolType == "K8") {
   //       var subject = subjectIlearn
   //    }
   //    else if ((schoolType == "HS") || (schoolType == "AHS")) {
   //       var subject = subjectHS
   //    }

   // Single Year Analysis Page //
   //Comparison: Current Year ELA Proficiency
   //Comparison: Current Year Math Proficiency
   //Comparison: Current Year IREAD Proficiency
   //Comparison: ELA Proficiency by Ethnicity
   //Comparison: IREAD Proficiency by Ethnicity
   //Comparison: Math Proficiency by Ethnicity
   //Comparison: ELA Proficiency by Subgroup
   //Comparison: IREAD Proficiency by Subgroup
   //Comparison: Math Proficiency by Subgroup

   let yearData = data.filter(o => o.Year == Number(year));
   const schoolName = yearData.find(d => d["School ID"] === schoolID)["School Name"];

   let ecbeData = getK8LineData(yearData, ethnicity, subject[0], selection)
   // filter out categories where the school has no data
   let ecbeSchoolColumns = Object.keys(ecbeData.find(d => d["School Name"] === schoolName));
   let ecbeFilteredData = filterKeys(ecbeData, ecbeSchoolColumns)
   let elaComparisonByEthnicityTransposed = transposeData(ecbeFilteredData, "School Name");

   // TODO:GET INSUFFICIENT N HERE ?- val is not 0 it is non-existent
   var elaComparisonByEthnicityChartData = processBarData(elaComparisonByEthnicityTransposed);


   let ecbsData = getK8LineData(yearData, subgroup, subject[0], selection)
   let ecbsSchoolColumns = Object.keys(ecbsData.find(d => d["School Name"] === schoolName));
   let ecbsFilteredData = filterKeys(ecbsData, ecbsSchoolColumns)
   let elaComparisonBySubGroupTransposed = transposeData(ecbsFilteredData, "School Name");

   // TODO:GET INSUFFICIENT N HERE ?- val is not 0 it is non-existent
   var elaComparisonBySubgroupChartData = processBarData(elaComparisonBySubGroupTransposed);

   if (!academicAnalysisPage.initialize){

      elaComparisonByEthnicity = verticalGroupBar().data(elaComparisonByEthnicityChartData).id("elaComparisonByEthnicity");
      d3.select("#elaComparisonByEthnicity").call(elaComparisonByEthnicity);

      elaComparisonBySubgroup = verticalGroupBar().data(elaComparisonBySubgroupChartData).id("elaComparisonBySubgroup");
      d3.select("#elaComparisonBySubgroup").call(elaComparisonBySubgroup);

   // Initialize analysis tables on-load (as empty)
   for (let k = 0; k < 2; k++) {
      let analysisTableName = "analysis-table" + (k+1);
      let analysisTableID = "#" + analysisTableName

      let analysisTableOptions = initializeTable(analysisTableID)
      var analysisGridDiv = document.querySelector(analysisTableID)
      analysisGridApi[k] = agGrid.createGrid(analysisGridDiv, analysisTableOptions);
   }
      // let analysisTableID = "#analysis-table1"
      // let analysisTableOptions = initializeTable(analysisTableID)
      // let analysisGridDiv = document.querySelector(analysisTableID)
      // analysisGridApi[0] = agGrid.createGrid(analysisGridDiv, analysisTableOptions);

   academicAnalysisPage.initialize = true;
   
   } else {

      elaComparisonByEthnicity.data(elaComparisonByEthnicityChartData).id("elaComparisonByEthnicity");
      elaComparisonBySubgroup.data(elaComparisonBySubgroupChartData).id("elaComparisonBySubgroup");


      // get colors from chart so we can add to table
      let tst, fill;
      let colorArray = [];

      let colorList = d3.select("#elaComparisonBySubgroup").selectAll("g.legend").select("rect");

      colorList.each(function() {
         name = this.__data__
         fill = this.style.fill.slice(3)
         const z = fill.slice(1, -1).split(",").map(Number);
         let clr = rgbToHex(z[0],z[1],z[2])
         colorArray.push({
            school: name,
            color: clr
         });
      });

      console.log(colorArray)

      //TODO: TEST THIS
      function SquareIconRenderer() {}

      SquareIconRenderer.prototype.init = function (params) {
      this.eGui = document.createElement('div');
      this.eGui.innerHTML = `<i class="fa fa-square"></i>`; // Use the appropriate icon class
      // this.eGui.color = ""
      };

      SquareIconRenderer.prototype.getGui = function () {
      return this.eGui;
      };

      // columnDefs: [
      //    {
      //       field: 'yourFieldName',
      //       cellRenderer: 'SquareIconRenderer', // Use the name of your renderer function
      //    },
      //    // ... other column definitions
      //    ]

      /* Update Tables */

      let analysisTableData, analysisTableID, analysisCatList;
      let tableNum = 2;
      let tableShift = 0;

      // Remove objects with years > the selected year
      const tabledata = yearData.filter((obj, index) => !(obj.Year > Number(year)));
      //TODO: TEMP
      let subject = ["ELA", "ELA"]

      for (let i=0; i<tableNum; i++) {

         let index = i + tableShift;
         const sub = i % 2;

         if (tableShift == 0) {
            analysisCatList = [ethnicity, subgroup] //             catList = [grade, ethnicity, subgroup]
         }
         else {
            analysisCatList = [grade, grade, ethnicity, ethnicity, subgroup, subgroup]
         }

         analysisTableID = analysisGridApi[index].getGridId()

         analysisTableData = getAnalysisTableData(tabledata, analysisCatList[i], subject[sub], selection)

         let analysisTableOptions = createAnalysisTable(analysisTableData, analysisTableID)

         // need to reset columndefs as well as rowdata or else table
         // will have empty cols.
         analysisGridApi[index].setGridOption("columnDefs", analysisTableOptions.columnDefs);
         analysisGridApi[index].setGridOption("rowData", analysisTableData);
      };



      // Remove objects with years > the selected year
      // let yeardata = yearData.filter((obj, index) => !(obj.Year > Number(year)));
      // analysisTableID = analysisGridApi[0].getGridId()
      // analysisTableData = getAnalysisTableData(yeardata, ethnicity, "ELA", selection)
      // let analysisTableOptions = createAnalysisTable(analysisTableData, analysisTableID)
      // analysisGridApi[0].setGridOption("columnDefs", analysisTableOptions.columnDefs);
      // analysisGridApi[0].setGridOption("rowData", analysisTableData);

   }
   // TODO: Multi-Year Analysis Page
};


// Navigation //
if (allnav.addEventListener) {
   allnav.addEventListener('click',navigateHandler,false);
}
else {
   allnav.addEventListener('onclick',navigateHandler);

}

function navigateHandler(e) {
   const mainSelection = document.querySelector(".tab.main.active").id;
   const k8Selection = document.querySelector(".tab.k8info.active").id;
   const hsSelection = document.querySelector(".tab.hsinfo.active").id;
   const typeSelection = document.querySelector(".tab.type.active").id;
   const analysisSelection = document.querySelector(".tab.analysis.active").id;

   const k8Content = document.querySelector(".k8nav");
   const hsContent = document.querySelector(".hsnav");
   const typeContent = document.querySelector(".typenav");
   const analysisContent = document.querySelector(".analysisnav");

   // let singleYearTab = document.getElementById("singleTab");
   // let multiYearTab = document.getElementById("multiTab");

   // target is the button triggering the onClick
   // mainSelection is the main nav (demoTab, infoTab, analysisTab)
   // subSelection is info-k8nav (ireadTab, ilearnTab)
   // typeSelection is type nav (K8, HS)
   // target will be equal to one of the above selections
   e = e || window.event;
   var target = e.target || e.srcElement;

   var selectedValues = getSelectedValues();

   const selectedPage = selectedValues.page_tab;

   const strYear = selectedValues.year;
   const intYear = parseInt(strYear)
   let yearValue;

   const schoolType = selectedValues.school_type;
   const schoolSubtype = selectedValues.school_subtype;

   // the iread/ilearn tabs should never be visible when HS is selected
   // and should always be available when K8 is selected
   if (target.id.match("hsTab")) {
      k8Content.classList.remove("open");
      hsContent.classList.add("open");
   }

   if (target.id.match("k8Tab")) {
      k8Content.classList.add("open");
      hsContent.classList.remove("open");
   }

   if (target.id.match("demoTab")) {

      k8Content.classList.remove("open");
      hsContent.classList.remove("open");
      typeContent.classList.remove("open");
      analysisContent.classList.remove("open");

      setYearList(allSchoolsObj,"demographic");

      yearSelection.value = strYear;
      yearSelection.setAttribute("value", strYear);

      getDemographicData(selectedValues);

      // adjust chart size based on browser window size
      let windowWidth = window.innerWidth/2 - 125;
      enrollmentChart.width(windowWidth);
      attendanceChart.width(windowWidth);
      ethnicityDemoChart.width(windowWidth);
      statusDemoChart.width(windowWidth);      
   }

   else if (
      target.id.match("infoTab") ||
      selectedPage.match("infoTab") &&
         (target.id.match("ilearnTab") ||
         target.id.match("ireadTab") ||
         target.id.match("k8Tab") ||
         target.id.match("hsTab") ||
         target.id.match("gradTab") ||
         target.id.match("satTab"))
   ) {

      let stacks = document.querySelectorAll('[id^="info-container-stack"]');
      let infoLg = document.querySelectorAll('[id^="info-container-lg"]');
      let infoSm = document.querySelectorAll('[id^="info-container-sm"]');

      analysisContent.classList.remove("open");

      if (schoolType == "K12") {
         typeContent.classList.add("open");
      }
      else {
         typeContent.classList.remove("open");
      }

      if (
         (schoolType == "K8" && schoolSubtype != "MS") ||
         (schoolType == "K12" && schoolSubtype == "K8") ||
         schoolSubtype == "K8"
      ) {      

         k8Content.classList.add("open");

         if (k8Selection == "ireadTab") {
            stacks.forEach(el => {
               el.style.display = "none"; 
            });
            infoSm.forEach(el => {
               el.style.display = "flex"; 
            });
            infoLg.forEach(el => {
               el.style.display = "none"; 
            });
         }
         else if (k8Selection == "ilearnTab") {
            stacks.forEach(el => {
               el.style.display = "flex"; 
            });
            infoSm.forEach(el => {
               el.style.display = "none"; 
            });
            infoLg.forEach(el => {
               el.style.display = "flex"; 
            });            
         }
      }
      else if (
         (schoolType == "K12" && schoolSubtype == "HS") ||
         schoolType == "HS"
      ) {
         stacks.forEach(el => {
            el.style.display = "none";
         });

         if (hsSelection == "gradTab") {
            stacks.forEach(el => {
               el.style.display = "none"; 
            });
            infoSm.forEach(el => {
               el.style.display = "flex"; 
            });
            infoLg.forEach(el => {
               el.style.display = "none"; 
            });
         }
         else if (hsSelection == "satTab") {
            stacks.forEach(el => {
               el.style.display = "none"; 
            });
            infoSm.forEach(el => {
               el.style.display = "none"; 
            });
            infoLg.forEach(el => {
               el.style.display = "flex"; 
            });            
         }

         k8Content.classList.remove("open");
         hsContent.classList.add("open");
      }      

      setYearList(allSchoolsObj,"academic");

      if (strYear == "2020") {
         yearValue = "2019";
      }
      else if (intYear > curAcademicYear) {
         yearValue = curAcademicYear.toString();
      }
      else {
         yearValue = strYear;
      }

      yearSelection.value = yearValue;
      yearSelection.setAttribute("value", yearValue);

      selectedValues["year"] = yearValue;

      // TODO: testing this - want to make sure a HS doesn't have type ireadTab or ilearnTab
      if (schoolType == "HS" || schoolSubtype == "HS") {
         selectedValues.page_tab = "infoTab";
      }

      getAcademicInfoData(selectedValues);

      // adjust chart size based on browser window size
      let windowWidth = window.innerWidth/2 - 125;
      infoChart1.width(windowWidth);
      infoChart2.width(windowWidth);
      infoChart3.width(windowWidth);
      infoChart4.width(windowWidth);
      infoChart5.width(windowWidth);
      infoChart6.width(windowWidth);
      infoChart7.width(windowWidth);
      infoChart8.width(windowWidth);
      infoChart9.width(windowWidth);

    }
    else if (
      target.id.match("analysisTab") ||
      selectedPage.match("analysisTab") &&
         (target.id.match("ilearnTab") ||
         target.id.match("ireadTab") ||
         target.id.match("k8Tab") ||
         target.id.match("hsTab") ||
         target.id.match("gradTab") ||
         target.id.match("satTab"))
   ) {
   
      analysisContent.classList.add("open");

      setYearList(allSchoolsObj,"academic");

      if (strYear == 2020) {
         yearValue = 2019;
      }
      else if (intYear > curAcademicYear) {
         yearValue = curAcademicYear.toString();;
      }
      else {
         yearValue = strYear;
      }

      yearSelection.value = yearValue;
      yearSelection.setAttribute("value", yearValue);

      selectedValues.year = yearValue;
      selectedValues.comparison_schools = getComparisonSchoolIDs()
      console.log("Tracking Selected - NAV HANDLER")
      console.log(selectedValues)
      getAcademicAnalysisData(selectedValues);
   }
}

/* Main Block */

// Preload all charts on all tabs on first load
if (document.readyState !== "loading") {
   setYearList(allSchoolsObj,"demographic");

   let selectedValues = getSelectedValues();

   const k8Content = document.querySelector(".k8nav");
   const hsContent = document.querySelector(".hsnav");
   const typeContent = document.querySelector(".typenav");
   const analysisContent = document.querySelector(".analysisnav");

   analysisContent.classList.remove("open");
   typeContent.classList.remove("open");
   hsContent.classList.remove("open");
   k8Content.classList.remove("open");
      
   getDemographicData(selectedValues);
   getAcademicInfoData(selectedValues);

   getComparisonSchools(selectedValues);
   // set selectedValues with initial values
   // let schoolIDs = comparisonSchoolList.map(obj => obj["School ID"]);
   // schoolIDs = schoolIDs.slice(0, 5);
   // setSelectedValue("comparison_schools", schoolIDs)

   // NOTE: at this point getComparisonSchoolIDs() returns [] because comparisonSelect
   // isn't yet initialized
   selectedValues.comparison_schools = getComparisonSchoolIDs()

   getAcademicAnalysisData(selectedValues);
}

// initialize page by setting the corp list
setCorpList(allSchoolsObj)

d3.select(window).on("resize", resize);

function resize() {
   // TODO: prob better way to do this- at this point setting size
   // as half the value of the innerwidth of the window
   // TODO: Add breakpoint for single cols
   // TODO: create function for width calls
   // TODO: Add call to fix chart legends

   let selectedValues = getSelectedValues();

   let windowWidth = window.innerWidth/2 - 125;
   
   if (windowWidth >= 290) {

      if (selectedValues.page_tab === "Academic Analysis") {
      
      }
      else if (selectedValues.page_tab === "Academic Information") {

         infoChart1.width(windowWidth);
         infoChart2.width(windowWidth);
         infoChart3.width(windowWidth);
         infoChart4.width(windowWidth);
         infoChart5.width(windowWidth);
         infoChart6.width(windowWidth);
         infoChart7.width(windowWidth);
         infoChart8.width(windowWidth);
         infoChart9.width(windowWidth);
      }
      else {
         enrollmentChart.width(windowWidth);
         attendanceChart.width(windowWidth);
         ethnicityDemoChart.width(windowWidth);
         statusDemoChart.width(windowWidth);
      }
   }
}
</script>
</html>